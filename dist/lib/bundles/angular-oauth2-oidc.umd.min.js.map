{"version":3,"sources":["../../../projects/lib/src/types.ts","../../../node_modules/tslib/tslib.es6.js","../../../projects/lib/src/base64-helper.ts","../../../projects/lib/src/token-validation/validation-handler.ts","../../../projects/lib/src/url-helper.service.ts","../../../projects/lib/src/events.ts","../../../projects/lib/src/auth.config.ts","../../../projects/lib/src/encoder.ts","../../../projects/lib/src/token-validation/js-sha256.js","../../../projects/lib/src/token-validation/hash-handler.ts","../../../projects/lib/src/oauth-service.ts","../../../projects/lib/src/oauth-module.config.ts","../../../projects/lib/src/interceptors/resource-server-error-handler.ts","../../../projects/lib/src/interceptors/default-oauth.interceptor.ts","../../../projects/lib/src/token-validation/null-validation-handler.ts","../../../projects/lib/src/factories.ts","../../../projects/lib/src/angular-oauth-oidc.module.ts","../../../projects/lib/src/token-validation/jwks-validation-handler.ts","../../../projects/lib/src/tokens.ts"],"names":["this","preventClearHashAfterLogin","MemoryStorage","data","Map","prototype","getItem","key","get","removeItem","delete","setItem","set","Injectable","extendStatics","d","b","Object","setPrototypeOf","__proto__","Array","p","hasOwnProperty","call","__extends","__","constructor","create","__assign","assign","t","s","i","n","arguments","length","apply","__rest","e","indexOf","getOwnPropertySymbols","propertyIsEnumerable","__decorate","decorators","target","desc","c","r","getOwnPropertyDescriptor","Reflect","decorate","defineProperty","__param","paramIndex","decorator","__metadata","metadataKey","metadataValue","metadata","__awaiter","thisArg","_arguments","P","generator","Promise","resolve","reject","fulfilled","value","step","next","rejected","result","done","then","__generator","body","f","y","g","_","label","sent","trys","ops","verb","throw","return","Symbol","iterator","v","op","TypeError","pop","push","__createBinding","o","m","k","k2","undefined","enumerable","__exportStar","__values","__read","ar","error","__spread","concat","__spreadArrays","il","a","j","jl","__await","__asyncGenerator","asyncIterator","q","resume","fulfill","settle","shift","__asyncDelegator","__asyncValues","__makeTemplateObject","cooked","raw","__setModuleDefault","__importStar","mod","__esModule","__importDefault","default","__classPrivateFieldGet","receiver","privateMap","has","__classPrivateFieldSet","b64DecodeUnicode","str","base64","replace","decodeURIComponent","atob","split","map","charCodeAt","toString","slice","join","base64UrlEncode","btoa","AbstractValidationHandler","validateAtHash","params","hashAlg","inferHashAlgorithm","idTokenHeader","calcHash","accessToken","tokenHash","_a","leftMostHalf","substr","atHash","claimsAtHash","idTokenClaims","console","jwtHeader","alg","match","Error","UrlHelperService","getHashFragmentParams","customHashFragment","hash","window","location","questionMarkPosition","parseQueryString","queryString","pairs","pair","separatorIndex","escapedKey","escapedValue","type","OAuthSuccessEvent","info","_this","_super","OAuthEvent","OAuthInfoEvent","OAuthErrorEvent","reason","json","clientId","redirectUri","postLogoutRedirectUri","loginUrl","scope","resource","rngUrl","oidc","requestAccessToken","options","issuer","logoutUrl","clearHashAfterLogin","tokenEndpoint","revocationEndpoint","customTokenParameters","userinfoEndpoint","responseType","showDebugInformation","silentRefreshRedirectUri","silentRefreshMessagePrefix","silentRefreshShowIFrame","siletRefreshTimeout","silentRefreshTimeout","dummyClientSecret","requireHttps","strictDiscoveryDocumentValidation","jwks","customQueryParams","silentRefreshIFrameName","timeoutFactor","sessionChecksEnabled","sessionCheckIntervall","sessionCheckIFrameUrl","sessionCheckIFrameName","disableAtHashCheck","skipSubjectCheck","useIdTokenHintForSilentRefresh","skipIssuerCheck","nonceStateSeparator","useHttpBasicAuth","waitForTokenInMsec","disablePKCE","openUri","uri","href","WebHttpUrlEncodingCodec","encodeKey","encodeURIComponent","encodeValue","decodeKey","decodeValue","ERROR","WINDOW","root","JS_SHA256_NO_WINDOW","WEB_WORKER","self","NODE_JS","JS_SHA256_NO_NODE_JS","process","versions","node","global","COMMON_JS","JS_SHA256_NO_COMMON_JS","module","exports","AMD","define","amd","ARRAY_BUFFER","JS_SHA256_NO_ARRAY_BUFFER","ArrayBuffer","HEX_CHARS","EXTRA","SHIFT","K","OUTPUT_TYPES","blocks","isArray","obj","JS_SHA256_NO_ARRAY_BUFFER_IS_VIEW","isView","buffer","createOutputMethod","outputType","is224","message","Sha256","update","createMethod","method","nodeWrap","crypto","eval","Buffer","algorithm","nodeMethod","createHash","digest","Uint8Array","createHmacOutputMethod","HmacSha256","createHmacMethod","sharedMemory","h0","h1","h2","h3","h4","h5","h6","h7","block","start","bytes","hBytes","finalized","hashed","first","code","index","array","oKeyPad","iKeyPad","inner","notString","lastByteIndex","finalize","s0","s1","maj","t1","ab","da","cd","bc","h","hex","arr","arrayBuffer","dataView","DataView","setUint32","innerHash","sha256","sha224","hmac","DefaultHashHandler","valueToHash","hashArray","toHashString2","byteArray","byteArray_1","byteArray_1_1","String","fromCharCode","toHashString","byteArray_2","byteArray_2_1","OAuthService","ngZone","http","storage","tokenValidationHandler","config","urlHelper","logger","document","discoveryDocumentLoaded","state","eventsSubject","Subject","discoveryDocumentLoadedSubject","grantTypesSupported","inImplicitFlow","saveNoncesInLocalStorage","debug","discoveryDocumentLoaded$","asObservable","events","configure","setStorage","sessionStorage","ua","navigator","userAgent","includes","setupRefreshTimer","AuthConfig","setupSessionCheck","configChanged","restartSessionChecksIfStillLoggedIn","hasValidIdToken","initSessionCheck","restartRefreshTimerIfStillLoggedIn","clearAccessTokenTimer","clearIdTokenTimer","setupExpirationTimers","pipe","filter","subscribe","setupAutomaticSilentRefresh","listenTo","noPrompt","shouldRunSilentRefresh","tap","debounceTime","refreshInternal","catch","useSilentRefresh","silentRefresh","refreshToken","loadDiscoveryDocumentAndTryLogin","loadDiscoveryDocument","doc","tryLogin","loadDiscoveryDocumentAndLogin","hasValidAccessToken","initLoginFlow","args","_i","validateUrlFromDiscoveryDocument","url","errors","httpsCheck","validateUrlForHttps","issuerCheck","validateUrlAgainstIssuer","lcUrl","toLowerCase","startsWith","assertUrlNotNullAndCorrectProtocol","description","tokenReceivedSubscription","unsubscribe","setupAccessTokenTimer","setupIdTokenTimer","expiration","getAccessTokenExpiration","storedAt","getAccessTokenStoredAt","timeout","calcTimeout","runOutsideAngular","accessTokenTimeoutSubscription","of","delay","run","getIdTokenExpiration","getIdTokenStoredAt","idTokenTimeoutSubscription","stopAutomaticRefresh","now","Date","delta","Math","max","_storage","fullUrl","endsWith","validateDiscoveryDocument","authorization_endpoint","end_session_endpoint","grant_types_supported","token_endpoint","userinfo_endpoint","jwksUri","jwks_uri","check_session_iframe","revocation_endpoint","loadJwks","event","discoveryDocument","err","warn","fetchTokenUsingPasswordFlowAndLoadUserProfile","userName","password","headers","HttpHeaders","fetchTokenUsingPasswordFlow","loadUserProfile","getAccessToken","existingClaims","getIdentityClaims","sub","JSON","stringify","HttpParams","encoder","header","_c","getOwnPropertyNames","_d","post","tokenResponse","storeAccessTokenResponse","access_token","refresh_token","expires_in","fallbackAccessTokenExpirationTimeInSec","extractRecognizedCustomParameters","switchMap","id_token","from","processIdToken","storeIdToken","removeSilentRefreshEventListener","silentRefreshPostMessageEventListener","removeEventListener","setupSilentRefreshEventListener","processMessageEventMessage","customRedirectUri","addEventListener","claims","getIdToken","existingIframe","getElementById","removeChild","silentRefreshSubject","iframe","createElement","id","createLoginUrl","setAttribute","style","appendChild","success","race","toPromise","initImplicitFlowInPopup","initLoginFlowInPopup","display","checkForPopupClosedTimer","windowRef","open","calculatePopupFeatures","setInterval","closed","cleanup","clearInterval","listener","close","log","height","width","left","screenLeft","outerWidth","screenTop","outerHeight","expectedPrefix","prefixedMessage","canPerformSessionCheck","getSessionState","setupSessionCheckEventListener","removeSessionCheckEventListener","sessionCheckEventListener","origin","handleSessionUnchanged","handleSessionChange","handleSessionError","stopSessionCheckTimer","waitForSilentRefreshAfterSessionChange","logOut","startSessionCheckTimer","sessionCheckTimer","checkSession","bind","sessionState","contentWindow","postMessage","loginHint","that","createAndSaveNonce","nonce","_j","seperationChar","createChallangeVerifierPairForPKCE","_b","challenge","verifier","localStorage","keys","_e","_f","initImplicitFlowInternal","additionalState","addParams","initImplicitFlow","resetImplicitFlow","callOnTokenReceivedIfExists","onTokenReceived","tokenParams","idClaims","idToken","expiresIn","grantedScopes","customParameters","expiresInMilliSeconds","expiresAt","getTime","forEach","tryLoginCodeFlow","tryLoginImplicitFlow","charAt","querySource","substring","search","parts","getCodePartsFromUrl","history","replaceState","name","parseState","nonceInState","userState","handleLoginError","validateNonce","storeSessionState","getTokenFromCode","PKCEVerifier","fetchAndProcessToken","disableOAuth2StateCheck","validationHandler","idx","savedNonce","idTokenClaimsJson","idTokenExpiresAt","onLoginError","skipNonceCheck","tokenParts","headerJson","padBase64","parse","claimsJson","aud","every","iat","iss","issuedAtMSec","expiresAtMSec","exp","clockSkewInMSec","clockSkewInSec","validationParams","loadKeys","checkSignature","idTokenHeaderJson","checkAtHash","atHashValid","atHashCheckEnabled","atHashValid1","getGrantedScopes","scopes","base64data","getRefreshToken","parseInt","getCustomTokenResponseProperty","requestedProperty","authorizationHeader","noRedirectToLogoutUrl","customParam","postLogoutUrl","createNonce","ngOnDestroy","silentRefreshFrame","remove","sessionCheckFrame","unreserved","size","getRandomValues","x","random","validateSignature","initCodeFlow","initCodeFlowInternal","challengeRaw","foundParameters","recognizedParameter","revokeTokenAndLogout","ignoreCorsIssues","revokeEndpoint","revokeAccessToken","revokeRefreshToken","revokationParams","catchError","status","throwError","combineLatest","res","NgZone","HttpClient","OAuthStorage","Optional","ValidationHandler","OAuthLogger","HashHandler","Inject","DOCUMENT","OAuthNoopResourceServerErrorHandler","handleError","DefaultOAuthInterceptor","authStorage","oAuthService","errorHandler","moduleConfig","checkUrl","resourceServer","customUrlValidation","allowedUrls","find","u","intercept","req","sendAccessToken","merge","token","take","mergeMap","clone","handle","OAuthResourceServerErrorHandler","OAuthModuleConfig","NullValidationHandler","createDefaultLogger","createDefaultStorage","OAuthModule","forRoot","validationHandlerClass","ngModule","providers","provide","useFactory","useClass","useValue","HTTP_INTERCEPTORS","multi","NgModule","imports","CommonModule","declarations","JwksValidationHandler","AUTH_CONFIG","InjectionToken"],"mappings":"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","sourcesContent":["import { Injectable } from '@angular/core';\r\n\r\n/**\r\n * Additional options that can be passed to tryLogin.\r\n */\r\nexport class LoginOptions {\r\n  /**\r\n   * Is called, after a token has been received and\r\n   * successfully validated.\r\n   *\r\n   * Deprecated:  Use property ``events`` on OAuthService instead.\r\n   */\r\n  onTokenReceived?: (receivedTokens: ReceivedTokens) => void;\r\n\r\n  /**\r\n   * Hook, to validate the received tokens.\r\n   *\r\n   * Deprecated:  Use property ``tokenValidationHandler`` on OAuthService instead.\r\n   */\r\n  validationHandler?: (receivedTokens: ReceivedTokens) => Promise<any>;\r\n\r\n  /**\r\n   * Called when tryLogin detects that the auth server\r\n   * included an error message into the hash fragment.\r\n   *\r\n   * Deprecated:  Use property ``events`` on OAuthService instead.\r\n   */\r\n  onLoginError?: (params: object) => void;\r\n\r\n  /**\r\n   * A custom hash fragment to be used instead of the\r\n   * actual one. This is used for silent refreshes, to\r\n   * pass the iframes hash fragment to this method, and\r\n   * is also used by popup flows in the same manner.\r\n   * This can be used with code flow, where is must be set\r\n   * to a hash symbol followed by the querystring. The\r\n   * question mark is optional, but may be present following\r\n   * the hash symbol.\r\n   */\r\n  customHashFragment?: string;\r\n\r\n  /**\r\n   * Set this to true to disable the oauth2 state\r\n   * check which is a best practice to avoid\r\n   * security attacks.\r\n   * As OIDC defines a nonce check that includes\r\n   * this, this can be set to true when only doing\r\n   * OIDC.\r\n   */\r\n  disableOAuth2StateCheck?: boolean;\r\n\r\n  /**\r\n   * Normally, you want to clear your hash fragment after\r\n   * the lib read the token(s) so that they are not displayed\r\n   * anymore in the url. If not, set this to true. For code flow\r\n   * this controls removing query string values.\r\n   */\r\n  preventClearHashAfterLogin? = false;\r\n\r\n  /**\r\n   * Set this for code flow if you used a custom redirect Uri\r\n   * when retrieving the code. This is used internally for silent\r\n   * refresh and popup flows.\r\n   */\r\n  customRedirectUri?: string;\r\n}\r\n\r\n/**\r\n * Defines the logging interface the OAuthService uses\r\n * internally. Is compatible with the `console` object,\r\n * but you can provide your own implementation as well\r\n * through dependency injection.\r\n */\r\nexport abstract class OAuthLogger {\r\n  abstract debug(message?: any, ...optionalParams: any[]): void;\r\n  abstract info(message?: any, ...optionalParams: any[]): void;\r\n  abstract log(message?: any, ...optionalParams: any[]): void;\r\n  abstract warn(message?: any, ...optionalParams: any[]): void;\r\n  abstract error(message?: any, ...optionalParams: any[]): void;\r\n}\r\n\r\n/**\r\n * Defines a simple storage that can be used for\r\n * storing the tokens at client side.\r\n * Is compatible to localStorage and sessionStorage,\r\n * but you can also create your own implementations.\r\n */\r\nexport abstract class OAuthStorage {\r\n  abstract getItem(key: string): string | null;\r\n  abstract removeItem(key: string): void;\r\n  abstract setItem(key: string, data: string): void;\r\n}\r\n\r\n@Injectable()\r\nexport class MemoryStorage implements OAuthStorage {\r\n  private data = new Map<string, string>();\r\n\r\n  getItem(key: string): string {\r\n    return this.data.get(key);\r\n  }\r\n\r\n  removeItem(key: string): void {\r\n    this.data.delete(key);\r\n  }\r\n\r\n  setItem(key: string, data: string): void {\r\n    this.data.set(key, data);\r\n  }\r\n}\r\n\r\n/**\r\n * Represents the received tokens, the received state\r\n * and the parsed claims from the id-token.\r\n */\r\nexport class ReceivedTokens {\r\n  idToken: string;\r\n  accessToken: string;\r\n  idClaims?: object;\r\n  state?: string;\r\n}\r\n\r\n/**\r\n * Represents the parsed and validated id_token.\r\n */\r\nexport interface ParsedIdToken {\r\n  idToken: string;\r\n  idTokenClaims: object;\r\n  idTokenHeader: object;\r\n  idTokenClaimsJson: string;\r\n  idTokenHeaderJson: string;\r\n  idTokenExpiresAt: number;\r\n}\r\n\r\n/**\r\n * Represents the response from the token endpoint\r\n * http://openid.net/specs/openid-connect-core-1_0.html#TokenEndpoint\r\n */\r\nexport interface TokenResponse {\r\n  access_token: string;\r\n  id_token: string;\r\n  token_type: string;\r\n  expires_in: number;\r\n  refresh_token: string;\r\n  scope: string;\r\n  state?: string;\r\n}\r\n\r\n/**\r\n * Represents the response from the user info endpoint\r\n * http://openid.net/specs/openid-connect-core-1_0.html#UserInfo\r\n */\r\nexport interface UserInfo {\r\n  sub: string;\r\n  [key: string]: any;\r\n}\r\n\r\n/**\r\n * Represents an OpenID Connect discovery document\r\n */\r\nexport interface OidcDiscoveryDoc {\r\n  issuer: string;\r\n  authorization_endpoint: string;\r\n  token_endpoint: string;\r\n  token_endpoint_auth_methods_supported: string[];\r\n  token_endpoint_auth_signing_alg_values_supported: string[];\r\n  userinfo_endpoint: string;\r\n  check_session_iframe: string;\r\n  end_session_endpoint: string;\r\n  jwks_uri: string;\r\n  registration_endpoint: string;\r\n  scopes_supported: string[];\r\n  response_types_supported: string[];\r\n  acr_values_supported: string[];\r\n  response_modes_supported: string[];\r\n  grant_types_supported: string[];\r\n  subject_types_supported: string[];\r\n  userinfo_signing_alg_values_supported: string[];\r\n  userinfo_encryption_alg_values_supported: string[];\r\n  userinfo_encryption_enc_values_supported: string[];\r\n  id_token_signing_alg_values_supported: string[];\r\n  id_token_encryption_alg_values_supported: string[];\r\n  id_token_encryption_enc_values_supported: string[];\r\n  request_object_signing_alg_values_supported: string[];\r\n  display_values_supported: string[];\r\n  claim_types_supported: string[];\r\n  claims_supported: string[];\r\n  claims_parameter_supported: boolean;\r\n  service_documentation: string;\r\n  ui_locales_supported: string[];\r\n  revocation_endpoint: string;\r\n}\r\n","/*! *****************************************************************************\r\nCopyright (c) Microsoft Corporation.\r\n\r\nPermission to use, copy, modify, and/or distribute this software for any\r\npurpose with or without fee is hereby granted.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH\r\nREGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY\r\nAND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,\r\nINDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM\r\nLOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR\r\nOTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR\r\nPERFORMANCE OF THIS SOFTWARE.\r\n***************************************************************************** */\r\n/* global Reflect, Promise */\r\n\r\nvar extendStatics = function(d, b) {\r\n    extendStatics = Object.setPrototypeOf ||\r\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n        function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\r\n    return extendStatics(d, b);\r\n};\r\n\r\nexport function __extends(d, b) {\r\n    extendStatics(d, b);\r\n    function __() { this.constructor = d; }\r\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n}\r\n\r\nexport var __assign = function() {\r\n    __assign = Object.assign || function __assign(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\r\n        }\r\n        return t;\r\n    }\r\n    return __assign.apply(this, arguments);\r\n}\r\n\r\nexport function __rest(s, e) {\r\n    var t = {};\r\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\r\n        t[p] = s[p];\r\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\r\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\r\n            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\r\n                t[p[i]] = s[p[i]];\r\n        }\r\n    return t;\r\n}\r\n\r\nexport function __decorate(decorators, target, key, desc) {\r\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\r\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\r\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\r\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\r\n}\r\n\r\nexport function __param(paramIndex, decorator) {\r\n    return function (target, key) { decorator(target, key, paramIndex); }\r\n}\r\n\r\nexport function __metadata(metadataKey, metadataValue) {\r\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(metadataKey, metadataValue);\r\n}\r\n\r\nexport function __awaiter(thisArg, _arguments, P, generator) {\r\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n}\r\n\r\nexport function __generator(thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [op[0] & 2, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n}\r\n\r\nexport var __createBinding = Object.create ? (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\r\n}) : (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    o[k2] = m[k];\r\n});\r\n\r\nexport function __exportStar(m, o) {\r\n    for (var p in m) if (p !== \"default\" && !Object.prototype.hasOwnProperty.call(o, p)) __createBinding(o, m, p);\r\n}\r\n\r\nexport function __values(o) {\r\n    var s = typeof Symbol === \"function\" && Symbol.iterator, m = s && o[s], i = 0;\r\n    if (m) return m.call(o);\r\n    if (o && typeof o.length === \"number\") return {\r\n        next: function () {\r\n            if (o && i >= o.length) o = void 0;\r\n            return { value: o && o[i++], done: !o };\r\n        }\r\n    };\r\n    throw new TypeError(s ? \"Object is not iterable.\" : \"Symbol.iterator is not defined.\");\r\n}\r\n\r\nexport function __read(o, n) {\r\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator];\r\n    if (!m) return o;\r\n    var i = m.call(o), r, ar = [], e;\r\n    try {\r\n        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\r\n    }\r\n    catch (error) { e = { error: error }; }\r\n    finally {\r\n        try {\r\n            if (r && !r.done && (m = i[\"return\"])) m.call(i);\r\n        }\r\n        finally { if (e) throw e.error; }\r\n    }\r\n    return ar;\r\n}\r\n\r\nexport function __spread() {\r\n    for (var ar = [], i = 0; i < arguments.length; i++)\r\n        ar = ar.concat(__read(arguments[i]));\r\n    return ar;\r\n}\r\n\r\nexport function __spreadArrays() {\r\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\r\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\r\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\r\n            r[k] = a[j];\r\n    return r;\r\n};\r\n\r\nexport function __await(v) {\r\n    return this instanceof __await ? (this.v = v, this) : new __await(v);\r\n}\r\n\r\nexport function __asyncGenerator(thisArg, _arguments, generator) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var g = generator.apply(thisArg, _arguments || []), i, q = [];\r\n    return i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i;\r\n    function verb(n) { if (g[n]) i[n] = function (v) { return new Promise(function (a, b) { q.push([n, v, a, b]) > 1 || resume(n, v); }); }; }\r\n    function resume(n, v) { try { step(g[n](v)); } catch (e) { settle(q[0][3], e); } }\r\n    function step(r) { r.value instanceof __await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r); }\r\n    function fulfill(value) { resume(\"next\", value); }\r\n    function reject(value) { resume(\"throw\", value); }\r\n    function settle(f, v) { if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]); }\r\n}\r\n\r\nexport function __asyncDelegator(o) {\r\n    var i, p;\r\n    return i = {}, verb(\"next\"), verb(\"throw\", function (e) { throw e; }), verb(\"return\"), i[Symbol.iterator] = function () { return this; }, i;\r\n    function verb(n, f) { i[n] = o[n] ? function (v) { return (p = !p) ? { value: __await(o[n](v)), done: n === \"return\" } : f ? f(v) : v; } : f; }\r\n}\r\n\r\nexport function __asyncValues(o) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var m = o[Symbol.asyncIterator], i;\r\n    return m ? m.call(o) : (o = typeof __values === \"function\" ? __values(o) : o[Symbol.iterator](), i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i);\r\n    function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }\r\n    function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }\r\n}\r\n\r\nexport function __makeTemplateObject(cooked, raw) {\r\n    if (Object.defineProperty) { Object.defineProperty(cooked, \"raw\", { value: raw }); } else { cooked.raw = raw; }\r\n    return cooked;\r\n};\r\n\r\nvar __setModuleDefault = Object.create ? (function(o, v) {\r\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\r\n}) : function(o, v) {\r\n    o[\"default\"] = v;\r\n};\r\n\r\nexport function __importStar(mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\r\n    __setModuleDefault(result, mod);\r\n    return result;\r\n}\r\n\r\nexport function __importDefault(mod) {\r\n    return (mod && mod.__esModule) ? mod : { default: mod };\r\n}\r\n\r\nexport function __classPrivateFieldGet(receiver, privateMap) {\r\n    if (!privateMap.has(receiver)) {\r\n        throw new TypeError(\"attempted to get private field on non-instance\");\r\n    }\r\n    return privateMap.get(receiver);\r\n}\r\n\r\nexport function __classPrivateFieldSet(receiver, privateMap, value) {\r\n    if (!privateMap.has(receiver)) {\r\n        throw new TypeError(\"attempted to set private field on non-instance\");\r\n    }\r\n    privateMap.set(receiver, value);\r\n    return value;\r\n}\r\n","// see: https://developer.mozilla.org/en-US/docs/Web/API/WindowBase64/Base64_encoding_and_decoding#The_.22Unicode_Problem.22\r\nexport function b64DecodeUnicode(str) {\r\n  const base64 = str.replace(/\\-/g, '+').replace(/\\_/g, '/');\r\n\r\n  return decodeURIComponent(\r\n    atob(base64)\r\n      .split('')\r\n      .map(function(c) {\r\n        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);\r\n      })\r\n      .join('')\r\n  );\r\n}\r\n\r\nexport function base64UrlEncode(str): string {\r\n  const base64 = btoa(str);\r\n  return base64\r\n    .replace(/\\+/g, '-')\r\n    .replace(/\\//g, '_')\r\n    .replace(/=/g, '');\r\n}\r\n","import { base64UrlEncode } from '../base64-helper';\r\n\r\nexport interface ValidationParams {\r\n  idToken: string;\r\n  accessToken: string;\r\n  idTokenHeader: object;\r\n  idTokenClaims: object;\r\n  jwks: object;\r\n  loadKeys: () => Promise<object>;\r\n}\r\n\r\n/**\r\n * Interface for Handlers that are hooked in to\r\n * validate tokens.\r\n */\r\nexport abstract class ValidationHandler {\r\n  /**\r\n   * Validates the signature of an id_token.\r\n   */\r\n  public abstract validateSignature(\r\n    validationParams: ValidationParams\r\n  ): Promise<any>;\r\n\r\n  /**\r\n   * Validates the at_hash in an id_token against the received access_token.\r\n   */\r\n  public abstract validateAtHash(\r\n    validationParams: ValidationParams\r\n  ): Promise<boolean>;\r\n}\r\n\r\n/**\r\n * This abstract implementation of ValidationHandler already implements\r\n * the method validateAtHash. However, to make use of it,\r\n * you have to override the method calcHash.\r\n */\r\nexport abstract class AbstractValidationHandler implements ValidationHandler {\r\n  /**\r\n   * Validates the signature of an id_token.\r\n   */\r\n  abstract validateSignature(validationParams: ValidationParams): Promise<any>;\r\n\r\n  /**\r\n   * Validates the at_hash in an id_token against the received access_token.\r\n   */\r\n  async validateAtHash(params: ValidationParams): Promise<boolean> {\r\n    let hashAlg = this.inferHashAlgorithm(params.idTokenHeader);\r\n\r\n    let tokenHash = await this.calcHash(params.accessToken, hashAlg); // sha256(accessToken, { asString: true });\r\n\r\n    let leftMostHalf = tokenHash.substr(0, tokenHash.length / 2);\r\n\r\n    let atHash = base64UrlEncode(leftMostHalf);\r\n\r\n    let claimsAtHash = params.idTokenClaims['at_hash'].replace(/=/g, '');\r\n\r\n    if (atHash !== claimsAtHash) {\r\n      console.error('exptected at_hash: ' + atHash);\r\n      console.error('actual at_hash: ' + claimsAtHash);\r\n    }\r\n\r\n    return atHash === claimsAtHash;\r\n  }\r\n\r\n  /**\r\n   * Infers the name of the hash algorithm to use\r\n   * from the alg field of an id_token.\r\n   *\r\n   * @param jwtHeader the id_token's parsed header\r\n   */\r\n  protected inferHashAlgorithm(jwtHeader: object): string {\r\n    let alg: string = jwtHeader['alg'];\r\n\r\n    if (!alg.match(/^.S[0-9]{3}$/)) {\r\n      throw new Error('Algorithm not supported: ' + alg);\r\n    }\r\n\r\n    return 'sha-' + alg.substr(2);\r\n  }\r\n\r\n  /**\r\n   * Calculates the hash for the passed value by using\r\n   * the passed hash algorithm.\r\n   *\r\n   * @param valueToHash\r\n   * @param algorithm\r\n   */\r\n  protected abstract calcHash(\r\n    valueToHash: string,\r\n    algorithm: string\r\n  ): Promise<string>;\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\n@Injectable()\r\nexport class UrlHelperService {\r\n  public getHashFragmentParams(customHashFragment?: string): object {\r\n    let hash = customHashFragment || window.location.hash;\r\n\r\n    hash = decodeURIComponent(hash);\r\n\r\n    if (hash.indexOf('#') !== 0) {\r\n      return {};\r\n    }\r\n\r\n    const questionMarkPosition = hash.indexOf('?');\r\n\r\n    if (questionMarkPosition > -1) {\r\n      hash = hash.substr(questionMarkPosition + 1);\r\n    } else {\r\n      hash = hash.substr(1);\r\n    }\r\n\r\n    return this.parseQueryString(hash);\r\n  }\r\n\r\n  public parseQueryString(queryString: string): object {\r\n    const data = {};\r\n    let pairs, pair, separatorIndex, escapedKey, escapedValue, key, value;\r\n\r\n    if (queryString === null) {\r\n      return data;\r\n    }\r\n\r\n    pairs = queryString.split('&');\r\n\r\n    for (let i = 0; i < pairs.length; i++) {\r\n      pair = pairs[i];\r\n      separatorIndex = pair.indexOf('=');\r\n\r\n      if (separatorIndex === -1) {\r\n        escapedKey = pair;\r\n        escapedValue = null;\r\n      } else {\r\n        escapedKey = pair.substr(0, separatorIndex);\r\n        escapedValue = pair.substr(separatorIndex + 1);\r\n      }\r\n\r\n      key = decodeURIComponent(escapedKey);\r\n      value = decodeURIComponent(escapedValue);\r\n\r\n      if (key.substr(0, 1) === '/') {\r\n        key = key.substr(1);\r\n      }\r\n\r\n      data[key] = value;\r\n    }\r\n\r\n    return data;\r\n  }\r\n}\r\n","export type EventType =\r\n  | 'discovery_document_loaded'\r\n  | 'jwks_load_error'\r\n  | 'invalid_nonce_in_state'\r\n  | 'discovery_document_load_error'\r\n  | 'discovery_document_validation_error'\r\n  | 'user_profile_loaded'\r\n  | 'user_profile_load_error'\r\n  | 'token_received'\r\n  | 'token_error'\r\n  | 'code_error'\r\n  | 'token_refreshed'\r\n  | 'token_refresh_error'\r\n  | 'silent_refresh_error'\r\n  | 'silently_refreshed'\r\n  | 'silent_refresh_timeout'\r\n  | 'token_validation_error'\r\n  | 'token_expires'\r\n  | 'session_changed'\r\n  | 'session_error'\r\n  | 'session_terminated'\r\n  | 'logout'\r\n  | 'popup_closed'\r\n  | 'popup_blocked'\r\n  | 'token_revoke_error';\r\n\r\nexport abstract class OAuthEvent {\r\n  constructor(readonly type: EventType) {}\r\n}\r\n\r\nexport class OAuthSuccessEvent extends OAuthEvent {\r\n  constructor(type: EventType, readonly info: any = null) {\r\n    super(type);\r\n  }\r\n}\r\n\r\nexport class OAuthInfoEvent extends OAuthEvent {\r\n  constructor(type: EventType, readonly info: any = null) {\r\n    super(type);\r\n  }\r\n}\r\n\r\nexport class OAuthErrorEvent extends OAuthEvent {\r\n  constructor(\r\n    type: EventType,\r\n    readonly reason: object,\r\n    readonly params: object = null\r\n  ) {\r\n    super(type);\r\n  }\r\n}\r\n","export class AuthConfig {\r\n  /**\r\n   * The client's id as registered with the auth server\r\n   */\r\n  public clientId? = '';\r\n\r\n  /**\r\n   * The client's redirectUri as registered with the auth server\r\n   */\r\n  public redirectUri? = '';\r\n\r\n  /**\r\n   * An optional second redirectUri where the auth server\r\n   * redirects the user to after logging out.\r\n   */\r\n  public postLogoutRedirectUri? = '';\r\n\r\n  /**\r\n   * The auth server's endpoint that allows to log\r\n   * the user in when using implicit flow.\r\n   */\r\n  public loginUrl? = '';\r\n\r\n  /**\r\n   * The requested scopes\r\n   */\r\n  public scope? = 'openid profile';\r\n\r\n  public resource? = '';\r\n\r\n  public rngUrl? = '';\r\n\r\n  /**\r\n   * Defines whether to use OpenId Connect during\r\n   * implicit flow.\r\n   */\r\n  public oidc? = true;\r\n\r\n  /**\r\n   * Defines whether to request an access token during\r\n   * implicit flow.\r\n   */\r\n  public requestAccessToken? = true;\r\n\r\n  public options?: any = null;\r\n\r\n  /**\r\n   * The issuer's uri.\r\n   */\r\n  public issuer? = '';\r\n\r\n  /**\r\n   * The logout url.\r\n   */\r\n  public logoutUrl? = '';\r\n\r\n  /**\r\n   * Defines whether to clear the hash fragment after logging in.\r\n   */\r\n  public clearHashAfterLogin? = true;\r\n\r\n  /**\r\n   * Url of the token endpoint as defined by OpenId Connect and OAuth 2.\r\n   */\r\n  public tokenEndpoint?: string = null;\r\n\r\n  /**\r\n   * Url of the revocation endpoint as defined by OpenId Connect and OAuth 2.\r\n   */\r\n  public revocationEndpoint?: string = null;\r\n\r\n  /**\r\n   * Names of known parameters sent out in the TokenResponse. https://tools.ietf.org/html/rfc6749#section-5.1\r\n   */\r\n  public customTokenParameters?: string[] = [];\r\n\r\n  /**\r\n   * Url of the userinfo endpoint as defined by OpenId Connect.\r\n   */\r\n  public userinfoEndpoint?: string = null;\r\n\r\n  public responseType? = '';\r\n\r\n  /**\r\n   * Defines whether additional debug information should\r\n   * be shown at the console. Note that in certain browsers\r\n   * the verbosity of the console needs to be explicitly set\r\n   * to include Debug level messages.\r\n   */\r\n  public showDebugInformation? = false;\r\n\r\n  /**\r\n   * The redirect uri used when doing silent refresh.\r\n   */\r\n  public silentRefreshRedirectUri? = '';\r\n\r\n  public silentRefreshMessagePrefix? = '';\r\n\r\n  /**\r\n   * Set this to true to display the iframe used for\r\n   * silent refresh for debugging.\r\n   */\r\n  public silentRefreshShowIFrame? = false;\r\n\r\n  /**\r\n   * Timeout for silent refresh.\r\n   * @internal\r\n   * depreacted b/c of typo, see silentRefreshTimeout\r\n   */\r\n  public siletRefreshTimeout?: number = 1000 * 20;\r\n\r\n  /**\r\n   * Timeout for silent refresh.\r\n   */\r\n  public silentRefreshTimeout?: number = 1000 * 20;\r\n\r\n  /**\r\n   * Some auth servers don't allow using password flow\r\n   * w/o a client secret while the standards do not\r\n   * demand for it. In this case, you can set a password\r\n   * here. As this password is exposed to the public\r\n   * it does not bring additional security and is therefore\r\n   * as good as using no password.\r\n   */\r\n  public dummyClientSecret?: string = null;\r\n\r\n  /**\r\n   * Defines whether https is required.\r\n   * The default value is remoteOnly which only allows\r\n   * http for localhost, while every other domains need\r\n   * to be used with https.\r\n   */\r\n  public requireHttps?: boolean | 'remoteOnly' = 'remoteOnly';\r\n\r\n  /**\r\n   * Defines whether every url provided by the discovery\r\n   * document has to start with the issuer's url.\r\n   */\r\n  public strictDiscoveryDocumentValidation? = true;\r\n\r\n  /**\r\n   * JSON Web Key Set (https://tools.ietf.org/html/rfc7517)\r\n   * with keys used to validate received id_tokens.\r\n   * This is taken out of the disovery document. Can be set manually too.\r\n   */\r\n  public jwks?: object = null;\r\n\r\n  /**\r\n   * Map with additional query parameter that are appended to\r\n   * the request when initializing implicit flow.\r\n   */\r\n  public customQueryParams?: object = null;\r\n\r\n  public silentRefreshIFrameName? = 'angular-oauth-oidc-silent-refresh-iframe';\r\n\r\n  /**\r\n   * Defines when the token_timeout event should be raised.\r\n   * If you set this to the default value 0.75, the event\r\n   * is triggered after 75% of the token's life time.\r\n   */\r\n  public timeoutFactor? = 0.75;\r\n\r\n  /**\r\n   * If true, the lib will try to check whether the user\r\n   * is still logged in on a regular basis as described\r\n   * in http://openid.net/specs/openid-connect-session-1_0.html#ChangeNotification\r\n   */\r\n  public sessionChecksEnabled? = false;\r\n\r\n  /**\r\n   * Interval in msec for checking the session\r\n   * according to http://openid.net/specs/openid-connect-session-1_0.html#ChangeNotification\r\n   */\r\n  public sessionCheckIntervall? = 3 * 1000;\r\n\r\n  /**\r\n   * Url for the iframe used for session checks\r\n   */\r\n  public sessionCheckIFrameUrl?: string = null;\r\n\r\n  /**\r\n   * Name of the iframe to use for session checks\r\n   */\r\n  public sessionCheckIFrameName? = 'angular-oauth-oidc-check-session-iframe';\r\n\r\n  /**\r\n   * This property has been introduced to disable at_hash checks\r\n   * and is indented for Identity Provider that does not deliver\r\n   * an at_hash EVEN THOUGH its recommended by the OIDC specs.\r\n   * Of course, when disabling these checks the we are bypassing\r\n   * a security check which means we are more vulnerable.\r\n   */\r\n  public disableAtHashCheck? = false;\r\n\r\n  /**\r\n   * Defines wether to check the subject of a refreshed token after silent refresh.\r\n   * Normally, it should be the same as before.\r\n   */\r\n  public skipSubjectCheck? = false;\r\n\r\n  public useIdTokenHintForSilentRefresh? = false;\r\n\r\n  /**\r\n   * Defined whether to skip the validation of the issuer in the discovery document.\r\n   * Normally, the discovey document's url starts with the url of the issuer.\r\n   */\r\n  public skipIssuerCheck? = false;\r\n\r\n  /**\r\n   * According to rfc6749 it is recommended (but not required) that the auth\r\n   * server exposes the access_token's life time in seconds.\r\n   * This is a fallback value for the case this value is not exposed.\r\n   */\r\n  public fallbackAccessTokenExpirationTimeInSec?: number;\r\n\r\n  /**\r\n   * final state sent to issuer is built as follows:\r\n   * state = nonce + nonceStateSeparator + additional state\r\n   * Default separator is ';' (encoded %3B).\r\n   * In rare cases, this character might be forbidden or inconvenient to use by the issuer so it can be customized.\r\n   */\r\n  public nonceStateSeparator? = ';';\r\n\r\n  /**\r\n   * Set this to true to use HTTP BASIC auth for AJAX calls\r\n   */\r\n  public useHttpBasicAuth? = false;\r\n\r\n  /**\r\n   * The window of time (in seconds) to allow the current time to deviate when validating id_token's iat and exp values.\r\n   */\r\n  public clockSkewInSec?: number;\r\n\r\n  /**\r\n   * The interceptors waits this time span if there is no token\r\n   */\r\n  public waitForTokenInMsec? = 0;\r\n\r\n  /**\r\n   * Set this to true if you want to use silent refresh together with\r\n   * code flow. As silent refresh is the only option for refreshing\r\n   * with implicit flow, you don't need to explicitly turn it on in\r\n   * this case.\r\n   */\r\n  public useSilentRefresh?;\r\n\r\n  /**\r\n   * Code Flow is by defauld used together with PKCI which is also higly recommented.\r\n   * You can disbale it here by setting this flag to true.\r\n   * https://tools.ietf.org/html/rfc7636#section-1.1\r\n   */\r\n  public disablePKCE? = false;\r\n\r\n  constructor(json?: Partial<AuthConfig>) {\r\n    if (json) {\r\n      Object.assign(this, json);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * This property allows you to override the method that is used to open the login url,\r\n   * allowing a way for implementations to specify their own method of routing to new\r\n   * urls.\r\n   */\r\n  public openUri?: (uri: string) => void = uri => {\r\n    location.href = uri;\r\n  };\r\n}\r\n","import { HttpParameterCodec } from '@angular/common/http';\r\n/**\r\n * This custom encoder allows charactes like +, % and / to be used in passwords\r\n */\r\nexport class WebHttpUrlEncodingCodec implements HttpParameterCodec {\r\n  encodeKey(k: string): string {\r\n    return encodeURIComponent(k);\r\n  }\r\n\r\n  encodeValue(v: string): string {\r\n    return encodeURIComponent(v);\r\n  }\r\n\r\n  decodeKey(k: string): string {\r\n    return decodeURIComponent(k);\r\n  }\r\n\r\n  decodeValue(v: string) {\r\n    return decodeURIComponent(v);\r\n  }\r\n}\r\n","/**\r\n * [js-sha256]{@link https://github.com/emn178/js-sha256}\r\n *\r\n * @version 0.9.0\r\n * @author Chen, Yi-Cyuan [emn178@gmail.com]\r\n * @copyright Chen, Yi-Cyuan 2014-2017\r\n * @license MIT\r\n */\r\n/*jslint bitwise: true */\r\n\r\n  \r\n    var ERROR = 'input is invalid type';\r\n    var WINDOW = typeof window === 'object';\r\n    var root = WINDOW ? window : {};\r\n    if (root.JS_SHA256_NO_WINDOW) {\r\n      WINDOW = false;\r\n    }\r\n    var WEB_WORKER = !WINDOW && typeof self === 'object';\r\n    var NODE_JS = !root.JS_SHA256_NO_NODE_JS && typeof process === 'object' && process.versions && process.versions.node;\r\n    if (NODE_JS) {\r\n      root = global;\r\n    } else if (WEB_WORKER) {\r\n      root = self;\r\n    }\r\n    var COMMON_JS = !root.JS_SHA256_NO_COMMON_JS && typeof module === 'object' && module.exports;\r\n    var AMD = typeof define === 'function' && define.amd;\r\n    var ARRAY_BUFFER = !root.JS_SHA256_NO_ARRAY_BUFFER && typeof ArrayBuffer !== 'undefined';\r\n    var HEX_CHARS = '0123456789abcdef'.split('');\r\n    var EXTRA = [-2147483648, 8388608, 32768, 128];\r\n    var SHIFT = [24, 16, 8, 0];\r\n    var K = [\r\n      0x428a2f98, 0x71374491, 0xb5c0fbcf, 0xe9b5dba5, 0x3956c25b, 0x59f111f1, 0x923f82a4, 0xab1c5ed5,\r\n      0xd807aa98, 0x12835b01, 0x243185be, 0x550c7dc3, 0x72be5d74, 0x80deb1fe, 0x9bdc06a7, 0xc19bf174,\r\n      0xe49b69c1, 0xefbe4786, 0x0fc19dc6, 0x240ca1cc, 0x2de92c6f, 0x4a7484aa, 0x5cb0a9dc, 0x76f988da,\r\n      0x983e5152, 0xa831c66d, 0xb00327c8, 0xbf597fc7, 0xc6e00bf3, 0xd5a79147, 0x06ca6351, 0x14292967,\r\n      0x27b70a85, 0x2e1b2138, 0x4d2c6dfc, 0x53380d13, 0x650a7354, 0x766a0abb, 0x81c2c92e, 0x92722c85,\r\n      0xa2bfe8a1, 0xa81a664b, 0xc24b8b70, 0xc76c51a3, 0xd192e819, 0xd6990624, 0xf40e3585, 0x106aa070,\r\n      0x19a4c116, 0x1e376c08, 0x2748774c, 0x34b0bcb5, 0x391c0cb3, 0x4ed8aa4a, 0x5b9cca4f, 0x682e6ff3,\r\n      0x748f82ee, 0x78a5636f, 0x84c87814, 0x8cc70208, 0x90befffa, 0xa4506ceb, 0xbef9a3f7, 0xc67178f2\r\n    ];\r\n    var OUTPUT_TYPES = ['hex', 'array', 'digest', 'arrayBuffer'];\r\n  \r\n    var blocks = [];\r\n  \r\n    if (root.JS_SHA256_NO_NODE_JS || !Array.isArray) {\r\n      Array.isArray = function (obj) {\r\n        return Object.prototype.toString.call(obj) === '[object Array]';\r\n      };\r\n    }\r\n  \r\n    if (ARRAY_BUFFER && (root.JS_SHA256_NO_ARRAY_BUFFER_IS_VIEW || !ArrayBuffer.isView)) {\r\n      ArrayBuffer.isView = function (obj) {\r\n        return typeof obj === 'object' && obj.buffer && obj.buffer.constructor === ArrayBuffer;\r\n      };\r\n    }\r\n  \r\n    var createOutputMethod = function (outputType, is224) {\r\n      return function (message) {\r\n        return new Sha256(is224, true).update(message)[outputType]();\r\n      };\r\n    };\r\n  \r\n    var createMethod = function (is224) {\r\n      var method = createOutputMethod('hex', is224);\r\n      if (NODE_JS) {\r\n        method = nodeWrap(method, is224);\r\n      }\r\n      method.create = function () {\r\n        return new Sha256(is224);\r\n      };\r\n      method.update = function (message) {\r\n        return method.create().update(message);\r\n      };\r\n      for (var i = 0; i < OUTPUT_TYPES.length; ++i) {\r\n        var type = OUTPUT_TYPES[i];\r\n        method[type] = createOutputMethod(type, is224);\r\n      }\r\n      return method;\r\n    };\r\n  \r\n    var nodeWrap = function (method, is224) {\r\n      var crypto = eval(\"require('crypto')\");\r\n      var Buffer = eval(\"require('buffer').Buffer\");\r\n      var algorithm = is224 ? 'sha224' : 'sha256';\r\n      var nodeMethod = function (message) {\r\n        if (typeof message === 'string') {\r\n          return crypto.createHash(algorithm).update(message, 'utf8').digest('hex');\r\n        } else {\r\n          if (message === null || message === undefined) {\r\n            throw new Error(ERROR);\r\n          } else if (message.constructor === ArrayBuffer) {\r\n            message = new Uint8Array(message);\r\n          }\r\n        }\r\n        if (Array.isArray(message) || ArrayBuffer.isView(message) ||\r\n          message.constructor === Buffer) {\r\n          return crypto.createHash(algorithm).update(new Buffer(message)).digest('hex');\r\n        } else {\r\n          return method(message);\r\n        }\r\n      };\r\n      return nodeMethod;\r\n    };\r\n  \r\n    var createHmacOutputMethod = function (outputType, is224) {\r\n      return function (key, message) {\r\n        return new HmacSha256(key, is224, true).update(message)[outputType]();\r\n      };\r\n    };\r\n  \r\n    var createHmacMethod = function (is224) {\r\n      var method = createHmacOutputMethod('hex', is224);\r\n      method.create = function (key) {\r\n        return new HmacSha256(key, is224);\r\n      };\r\n      method.update = function (key, message) {\r\n        return method.create(key).update(message);\r\n      };\r\n      for (var i = 0; i < OUTPUT_TYPES.length; ++i) {\r\n        var type = OUTPUT_TYPES[i];\r\n        method[type] = createHmacOutputMethod(type, is224);\r\n      }\r\n      return method;\r\n    };\r\n  \r\n    function Sha256(is224, sharedMemory) {\r\n      if (sharedMemory) {\r\n        blocks[0] = blocks[16] = blocks[1] = blocks[2] = blocks[3] =\r\n          blocks[4] = blocks[5] = blocks[6] = blocks[7] =\r\n          blocks[8] = blocks[9] = blocks[10] = blocks[11] =\r\n          blocks[12] = blocks[13] = blocks[14] = blocks[15] = 0;\r\n        this.blocks = blocks;\r\n      } else {\r\n        this.blocks = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];\r\n      }\r\n  \r\n      if (is224) {\r\n        this.h0 = 0xc1059ed8;\r\n        this.h1 = 0x367cd507;\r\n        this.h2 = 0x3070dd17;\r\n        this.h3 = 0xf70e5939;\r\n        this.h4 = 0xffc00b31;\r\n        this.h5 = 0x68581511;\r\n        this.h6 = 0x64f98fa7;\r\n        this.h7 = 0xbefa4fa4;\r\n      } else { // 256\r\n        this.h0 = 0x6a09e667;\r\n        this.h1 = 0xbb67ae85;\r\n        this.h2 = 0x3c6ef372;\r\n        this.h3 = 0xa54ff53a;\r\n        this.h4 = 0x510e527f;\r\n        this.h5 = 0x9b05688c;\r\n        this.h6 = 0x1f83d9ab;\r\n        this.h7 = 0x5be0cd19;\r\n      }\r\n  \r\n      this.block = this.start = this.bytes = this.hBytes = 0;\r\n      this.finalized = this.hashed = false;\r\n      this.first = true;\r\n      this.is224 = is224;\r\n    }\r\n  \r\n    Sha256.prototype.update = function (message) {\r\n      if (this.finalized) {\r\n        return;\r\n      }\r\n      var notString, type = typeof message;\r\n      if (type !== 'string') {\r\n        if (type === 'object') {\r\n          if (message === null) {\r\n            throw new Error(ERROR);\r\n          } else if (ARRAY_BUFFER && message.constructor === ArrayBuffer) {\r\n            message = new Uint8Array(message);\r\n          } else if (!Array.isArray(message)) {\r\n            if (!ARRAY_BUFFER || !ArrayBuffer.isView(message)) {\r\n              throw new Error(ERROR);\r\n            }\r\n          }\r\n        } else {\r\n          throw new Error(ERROR);\r\n        }\r\n        notString = true;\r\n      }\r\n      var code, index = 0, i, length = message.length, blocks = this.blocks;\r\n  \r\n      while (index < length) {\r\n        if (this.hashed) {\r\n          this.hashed = false;\r\n          blocks[0] = this.block;\r\n          blocks[16] = blocks[1] = blocks[2] = blocks[3] =\r\n            blocks[4] = blocks[5] = blocks[6] = blocks[7] =\r\n            blocks[8] = blocks[9] = blocks[10] = blocks[11] =\r\n            blocks[12] = blocks[13] = blocks[14] = blocks[15] = 0;\r\n        }\r\n  \r\n        if (notString) {\r\n          for (i = this.start; index < length && i < 64; ++index) {\r\n            blocks[i >> 2] |= message[index] << SHIFT[i++ & 3];\r\n          }\r\n        } else {\r\n          for (i = this.start; index < length && i < 64; ++index) {\r\n            code = message.charCodeAt(index);\r\n            if (code < 0x80) {\r\n              blocks[i >> 2] |= code << SHIFT[i++ & 3];\r\n            } else if (code < 0x800) {\r\n              blocks[i >> 2] |= (0xc0 | (code >> 6)) << SHIFT[i++ & 3];\r\n              blocks[i >> 2] |= (0x80 | (code & 0x3f)) << SHIFT[i++ & 3];\r\n            } else if (code < 0xd800 || code >= 0xe000) {\r\n              blocks[i >> 2] |= (0xe0 | (code >> 12)) << SHIFT[i++ & 3];\r\n              blocks[i >> 2] |= (0x80 | ((code >> 6) & 0x3f)) << SHIFT[i++ & 3];\r\n              blocks[i >> 2] |= (0x80 | (code & 0x3f)) << SHIFT[i++ & 3];\r\n            } else {\r\n              code = 0x10000 + (((code & 0x3ff) << 10) | (message.charCodeAt(++index) & 0x3ff));\r\n              blocks[i >> 2] |= (0xf0 | (code >> 18)) << SHIFT[i++ & 3];\r\n              blocks[i >> 2] |= (0x80 | ((code >> 12) & 0x3f)) << SHIFT[i++ & 3];\r\n              blocks[i >> 2] |= (0x80 | ((code >> 6) & 0x3f)) << SHIFT[i++ & 3];\r\n              blocks[i >> 2] |= (0x80 | (code & 0x3f)) << SHIFT[i++ & 3];\r\n            }\r\n          }\r\n        }\r\n  \r\n        this.lastByteIndex = i;\r\n        this.bytes += i - this.start;\r\n        if (i >= 64) {\r\n          this.block = blocks[16];\r\n          this.start = i - 64;\r\n          this.hash();\r\n          this.hashed = true;\r\n        } else {\r\n          this.start = i;\r\n        }\r\n      }\r\n      if (this.bytes > 4294967295) {\r\n        this.hBytes += this.bytes / 4294967296 << 0;\r\n        this.bytes = this.bytes % 4294967296;\r\n      }\r\n      return this;\r\n    };\r\n  \r\n    Sha256.prototype.finalize = function () {\r\n      if (this.finalized) {\r\n        return;\r\n      }\r\n      this.finalized = true;\r\n      var blocks = this.blocks, i = this.lastByteIndex;\r\n      blocks[16] = this.block;\r\n      blocks[i >> 2] |= EXTRA[i & 3];\r\n      this.block = blocks[16];\r\n      if (i >= 56) {\r\n        if (!this.hashed) {\r\n          this.hash();\r\n        }\r\n        blocks[0] = this.block;\r\n        blocks[16] = blocks[1] = blocks[2] = blocks[3] =\r\n          blocks[4] = blocks[5] = blocks[6] = blocks[7] =\r\n          blocks[8] = blocks[9] = blocks[10] = blocks[11] =\r\n          blocks[12] = blocks[13] = blocks[14] = blocks[15] = 0;\r\n      }\r\n      blocks[14] = this.hBytes << 3 | this.bytes >>> 29;\r\n      blocks[15] = this.bytes << 3;\r\n      this.hash();\r\n    };\r\n  \r\n    Sha256.prototype.hash = function () {\r\n      var a = this.h0, b = this.h1, c = this.h2, d = this.h3, e = this.h4, f = this.h5, g = this.h6,\r\n        h = this.h7, blocks = this.blocks, j, s0, s1, maj, t1, t2, ch, ab, da, cd, bc;\r\n  \r\n      for (j = 16; j < 64; ++j) {\r\n        // rightrotate\r\n        t1 = blocks[j - 15];\r\n        s0 = ((t1 >>> 7) | (t1 << 25)) ^ ((t1 >>> 18) | (t1 << 14)) ^ (t1 >>> 3);\r\n        t1 = blocks[j - 2];\r\n        s1 = ((t1 >>> 17) | (t1 << 15)) ^ ((t1 >>> 19) | (t1 << 13)) ^ (t1 >>> 10);\r\n        blocks[j] = blocks[j - 16] + s0 + blocks[j - 7] + s1 << 0;\r\n      }\r\n  \r\n      bc = b & c;\r\n      for (j = 0; j < 64; j += 4) {\r\n        if (this.first) {\r\n          if (this.is224) {\r\n            ab = 300032;\r\n            t1 = blocks[0] - 1413257819;\r\n            h = t1 - 150054599 << 0;\r\n            d = t1 + 24177077 << 0;\r\n          } else {\r\n            ab = 704751109;\r\n            t1 = blocks[0] - 210244248;\r\n            h = t1 - 1521486534 << 0;\r\n            d = t1 + 143694565 << 0;\r\n          }\r\n          this.first = false;\r\n        } else {\r\n          s0 = ((a >>> 2) | (a << 30)) ^ ((a >>> 13) | (a << 19)) ^ ((a >>> 22) | (a << 10));\r\n          s1 = ((e >>> 6) | (e << 26)) ^ ((e >>> 11) | (e << 21)) ^ ((e >>> 25) | (e << 7));\r\n          ab = a & b;\r\n          maj = ab ^ (a & c) ^ bc;\r\n          ch = (e & f) ^ (~e & g);\r\n          t1 = h + s1 + ch + K[j] + blocks[j];\r\n          t2 = s0 + maj;\r\n          h = d + t1 << 0;\r\n          d = t1 + t2 << 0;\r\n        }\r\n        s0 = ((d >>> 2) | (d << 30)) ^ ((d >>> 13) | (d << 19)) ^ ((d >>> 22) | (d << 10));\r\n        s1 = ((h >>> 6) | (h << 26)) ^ ((h >>> 11) | (h << 21)) ^ ((h >>> 25) | (h << 7));\r\n        da = d & a;\r\n        maj = da ^ (d & b) ^ ab;\r\n        ch = (h & e) ^ (~h & f);\r\n        t1 = g + s1 + ch + K[j + 1] + blocks[j + 1];\r\n        t2 = s0 + maj;\r\n        g = c + t1 << 0;\r\n        c = t1 + t2 << 0;\r\n        s0 = ((c >>> 2) | (c << 30)) ^ ((c >>> 13) | (c << 19)) ^ ((c >>> 22) | (c << 10));\r\n        s1 = ((g >>> 6) | (g << 26)) ^ ((g >>> 11) | (g << 21)) ^ ((g >>> 25) | (g << 7));\r\n        cd = c & d;\r\n        maj = cd ^ (c & a) ^ da;\r\n        ch = (g & h) ^ (~g & e);\r\n        t1 = f + s1 + ch + K[j + 2] + blocks[j + 2];\r\n        t2 = s0 + maj;\r\n        f = b + t1 << 0;\r\n        b = t1 + t2 << 0;\r\n        s0 = ((b >>> 2) | (b << 30)) ^ ((b >>> 13) | (b << 19)) ^ ((b >>> 22) | (b << 10));\r\n        s1 = ((f >>> 6) | (f << 26)) ^ ((f >>> 11) | (f << 21)) ^ ((f >>> 25) | (f << 7));\r\n        bc = b & c;\r\n        maj = bc ^ (b & d) ^ cd;\r\n        ch = (f & g) ^ (~f & h);\r\n        t1 = e + s1 + ch + K[j + 3] + blocks[j + 3];\r\n        t2 = s0 + maj;\r\n        e = a + t1 << 0;\r\n        a = t1 + t2 << 0;\r\n      }\r\n  \r\n      this.h0 = this.h0 + a << 0;\r\n      this.h1 = this.h1 + b << 0;\r\n      this.h2 = this.h2 + c << 0;\r\n      this.h3 = this.h3 + d << 0;\r\n      this.h4 = this.h4 + e << 0;\r\n      this.h5 = this.h5 + f << 0;\r\n      this.h6 = this.h6 + g << 0;\r\n      this.h7 = this.h7 + h << 0;\r\n    };\r\n  \r\n    Sha256.prototype.hex = function () {\r\n      this.finalize();\r\n  \r\n      var h0 = this.h0, h1 = this.h1, h2 = this.h2, h3 = this.h3, h4 = this.h4, h5 = this.h5,\r\n        h6 = this.h6, h7 = this.h7;\r\n  \r\n      var hex = HEX_CHARS[(h0 >> 28) & 0x0F] + HEX_CHARS[(h0 >> 24) & 0x0F] +\r\n        HEX_CHARS[(h0 >> 20) & 0x0F] + HEX_CHARS[(h0 >> 16) & 0x0F] +\r\n        HEX_CHARS[(h0 >> 12) & 0x0F] + HEX_CHARS[(h0 >> 8) & 0x0F] +\r\n        HEX_CHARS[(h0 >> 4) & 0x0F] + HEX_CHARS[h0 & 0x0F] +\r\n        HEX_CHARS[(h1 >> 28) & 0x0F] + HEX_CHARS[(h1 >> 24) & 0x0F] +\r\n        HEX_CHARS[(h1 >> 20) & 0x0F] + HEX_CHARS[(h1 >> 16) & 0x0F] +\r\n        HEX_CHARS[(h1 >> 12) & 0x0F] + HEX_CHARS[(h1 >> 8) & 0x0F] +\r\n        HEX_CHARS[(h1 >> 4) & 0x0F] + HEX_CHARS[h1 & 0x0F] +\r\n        HEX_CHARS[(h2 >> 28) & 0x0F] + HEX_CHARS[(h2 >> 24) & 0x0F] +\r\n        HEX_CHARS[(h2 >> 20) & 0x0F] + HEX_CHARS[(h2 >> 16) & 0x0F] +\r\n        HEX_CHARS[(h2 >> 12) & 0x0F] + HEX_CHARS[(h2 >> 8) & 0x0F] +\r\n        HEX_CHARS[(h2 >> 4) & 0x0F] + HEX_CHARS[h2 & 0x0F] +\r\n        HEX_CHARS[(h3 >> 28) & 0x0F] + HEX_CHARS[(h3 >> 24) & 0x0F] +\r\n        HEX_CHARS[(h3 >> 20) & 0x0F] + HEX_CHARS[(h3 >> 16) & 0x0F] +\r\n        HEX_CHARS[(h3 >> 12) & 0x0F] + HEX_CHARS[(h3 >> 8) & 0x0F] +\r\n        HEX_CHARS[(h3 >> 4) & 0x0F] + HEX_CHARS[h3 & 0x0F] +\r\n        HEX_CHARS[(h4 >> 28) & 0x0F] + HEX_CHARS[(h4 >> 24) & 0x0F] +\r\n        HEX_CHARS[(h4 >> 20) & 0x0F] + HEX_CHARS[(h4 >> 16) & 0x0F] +\r\n        HEX_CHARS[(h4 >> 12) & 0x0F] + HEX_CHARS[(h4 >> 8) & 0x0F] +\r\n        HEX_CHARS[(h4 >> 4) & 0x0F] + HEX_CHARS[h4 & 0x0F] +\r\n        HEX_CHARS[(h5 >> 28) & 0x0F] + HEX_CHARS[(h5 >> 24) & 0x0F] +\r\n        HEX_CHARS[(h5 >> 20) & 0x0F] + HEX_CHARS[(h5 >> 16) & 0x0F] +\r\n        HEX_CHARS[(h5 >> 12) & 0x0F] + HEX_CHARS[(h5 >> 8) & 0x0F] +\r\n        HEX_CHARS[(h5 >> 4) & 0x0F] + HEX_CHARS[h5 & 0x0F] +\r\n        HEX_CHARS[(h6 >> 28) & 0x0F] + HEX_CHARS[(h6 >> 24) & 0x0F] +\r\n        HEX_CHARS[(h6 >> 20) & 0x0F] + HEX_CHARS[(h6 >> 16) & 0x0F] +\r\n        HEX_CHARS[(h6 >> 12) & 0x0F] + HEX_CHARS[(h6 >> 8) & 0x0F] +\r\n        HEX_CHARS[(h6 >> 4) & 0x0F] + HEX_CHARS[h6 & 0x0F];\r\n      if (!this.is224) {\r\n        hex += HEX_CHARS[(h7 >> 28) & 0x0F] + HEX_CHARS[(h7 >> 24) & 0x0F] +\r\n          HEX_CHARS[(h7 >> 20) & 0x0F] + HEX_CHARS[(h7 >> 16) & 0x0F] +\r\n          HEX_CHARS[(h7 >> 12) & 0x0F] + HEX_CHARS[(h7 >> 8) & 0x0F] +\r\n          HEX_CHARS[(h7 >> 4) & 0x0F] + HEX_CHARS[h7 & 0x0F];\r\n      }\r\n      return hex;\r\n    };\r\n  \r\n    Sha256.prototype.toString = Sha256.prototype.hex;\r\n  \r\n    Sha256.prototype.digest = function () {\r\n      this.finalize();\r\n  \r\n      var h0 = this.h0, h1 = this.h1, h2 = this.h2, h3 = this.h3, h4 = this.h4, h5 = this.h5,\r\n        h6 = this.h6, h7 = this.h7;\r\n  \r\n      var arr = [\r\n        (h0 >> 24) & 0xFF, (h0 >> 16) & 0xFF, (h0 >> 8) & 0xFF, h0 & 0xFF,\r\n        (h1 >> 24) & 0xFF, (h1 >> 16) & 0xFF, (h1 >> 8) & 0xFF, h1 & 0xFF,\r\n        (h2 >> 24) & 0xFF, (h2 >> 16) & 0xFF, (h2 >> 8) & 0xFF, h2 & 0xFF,\r\n        (h3 >> 24) & 0xFF, (h3 >> 16) & 0xFF, (h3 >> 8) & 0xFF, h3 & 0xFF,\r\n        (h4 >> 24) & 0xFF, (h4 >> 16) & 0xFF, (h4 >> 8) & 0xFF, h4 & 0xFF,\r\n        (h5 >> 24) & 0xFF, (h5 >> 16) & 0xFF, (h5 >> 8) & 0xFF, h5 & 0xFF,\r\n        (h6 >> 24) & 0xFF, (h6 >> 16) & 0xFF, (h6 >> 8) & 0xFF, h6 & 0xFF\r\n      ];\r\n      if (!this.is224) {\r\n        arr.push((h7 >> 24) & 0xFF, (h7 >> 16) & 0xFF, (h7 >> 8) & 0xFF, h7 & 0xFF);\r\n      }\r\n      return arr;\r\n    };\r\n  \r\n    Sha256.prototype.array = Sha256.prototype.digest;\r\n  \r\n    Sha256.prototype.arrayBuffer = function () {\r\n      this.finalize();\r\n  \r\n      var buffer = new ArrayBuffer(this.is224 ? 28 : 32);\r\n      var dataView = new DataView(buffer);\r\n      dataView.setUint32(0, this.h0);\r\n      dataView.setUint32(4, this.h1);\r\n      dataView.setUint32(8, this.h2);\r\n      dataView.setUint32(12, this.h3);\r\n      dataView.setUint32(16, this.h4);\r\n      dataView.setUint32(20, this.h5);\r\n      dataView.setUint32(24, this.h6);\r\n      if (!this.is224) {\r\n        dataView.setUint32(28, this.h7);\r\n      }\r\n      return buffer;\r\n    };\r\n  \r\n    function HmacSha256(key, is224, sharedMemory) {\r\n      var i, type = typeof key;\r\n      if (type === 'string') {\r\n        var bytes = [], length = key.length, index = 0, code;\r\n        for (i = 0; i < length; ++i) {\r\n          code = key.charCodeAt(i);\r\n          if (code < 0x80) {\r\n            bytes[index++] = code;\r\n          } else if (code < 0x800) {\r\n            bytes[index++] = (0xc0 | (code >> 6));\r\n            bytes[index++] = (0x80 | (code & 0x3f));\r\n          } else if (code < 0xd800 || code >= 0xe000) {\r\n            bytes[index++] = (0xe0 | (code >> 12));\r\n            bytes[index++] = (0x80 | ((code >> 6) & 0x3f));\r\n            bytes[index++] = (0x80 | (code & 0x3f));\r\n          } else {\r\n            code = 0x10000 + (((code & 0x3ff) << 10) | (key.charCodeAt(++i) & 0x3ff));\r\n            bytes[index++] = (0xf0 | (code >> 18));\r\n            bytes[index++] = (0x80 | ((code >> 12) & 0x3f));\r\n            bytes[index++] = (0x80 | ((code >> 6) & 0x3f));\r\n            bytes[index++] = (0x80 | (code & 0x3f));\r\n          }\r\n        }\r\n        key = bytes;\r\n      } else {\r\n        if (type === 'object') {\r\n          if (key === null) {\r\n            throw new Error(ERROR);\r\n          } else if (ARRAY_BUFFER && key.constructor === ArrayBuffer) {\r\n            key = new Uint8Array(key);\r\n          } else if (!Array.isArray(key)) {\r\n            if (!ARRAY_BUFFER || !ArrayBuffer.isView(key)) {\r\n              throw new Error(ERROR);\r\n            }\r\n          }\r\n        } else {\r\n          throw new Error(ERROR);\r\n        }\r\n      }\r\n  \r\n      if (key.length > 64) {\r\n        key = (new Sha256(is224, true)).update(key).array();\r\n      }\r\n  \r\n      var oKeyPad = [], iKeyPad = [];\r\n      for (i = 0; i < 64; ++i) {\r\n        var b = key[i] || 0;\r\n        oKeyPad[i] = 0x5c ^ b;\r\n        iKeyPad[i] = 0x36 ^ b;\r\n      }\r\n  \r\n      Sha256.call(this, is224, sharedMemory);\r\n  \r\n      this.update(iKeyPad);\r\n      this.oKeyPad = oKeyPad;\r\n      this.inner = true;\r\n      this.sharedMemory = sharedMemory;\r\n    }\r\n    HmacSha256.prototype = new Sha256();\r\n  \r\n    HmacSha256.prototype.finalize = function () {\r\n      Sha256.prototype.finalize.call(this);\r\n      if (this.inner) {\r\n        this.inner = false;\r\n        var innerHash = this.array();\r\n        Sha256.call(this, this.is224, this.sharedMemory);\r\n        this.update(this.oKeyPad);\r\n        this.update(innerHash);\r\n        Sha256.prototype.finalize.call(this);\r\n      }\r\n    };\r\n  \r\n    var exports = createMethod();\r\n    exports.sha256 = exports;\r\n    exports.sha224 = createMethod(true);\r\n    exports.sha256.hmac = createHmacMethod();\r\n    exports.sha224.hmac = createHmacMethod(true);\r\n  \r\n    export  { exports as sha256 };","import { Injectable } from '@angular/core';\r\n\r\nimport { sha256 } from './js-sha256';\r\n\r\n/**\r\n * Abstraction for crypto algorithms\r\n */\r\nexport abstract class HashHandler {\r\n  abstract calcHash(valueToHash: string, algorithm: string): Promise<string>;\r\n}\r\n\r\n@Injectable()\r\nexport class DefaultHashHandler implements HashHandler {\r\n  async calcHash(valueToHash: string, algorithm: string): Promise<string> {\r\n    // const encoder = new TextEncoder();\r\n    // const hashArray = await window.crypto.subtle.digest(algorithm, data);\r\n    // const data = encoder.encode(valueToHash);\r\n\r\n    const hashArray = (sha256 as any).array(valueToHash);\r\n    // const hashString = this.toHashString(hashArray);\r\n    const hashString = this.toHashString2(hashArray);\r\n\r\n    return hashString;\r\n  }\r\n\r\n  toHashString2(byteArray: number[]) {\r\n    let result = '';\r\n    for (let e of byteArray) {\r\n      result += String.fromCharCode(e);\r\n    }\r\n    return result;\r\n  }\r\n\r\n  toHashString(buffer: ArrayBuffer) {\r\n    const byteArray = new Uint8Array(buffer);\r\n    let result = '';\r\n    for (let e of byteArray) {\r\n      result += String.fromCharCode(e);\r\n    }\r\n    return result;\r\n  }\r\n\r\n  // hexString(buffer) {\r\n  //     const byteArray = new Uint8Array(buffer);\r\n  //     const hexCodes = [...byteArray].map(value => {\r\n  //       const hexCode = value.toString(16);\r\n  //       const paddedHexCode = hexCode.padStart(2, '0');\r\n  //       return paddedHexCode;\r\n  //     });\r\n\r\n  //     return hexCodes.join('');\r\n  //   }\r\n\r\n  // toHashString(hexString: string) {\r\n  //   let result = '';\r\n  //   for (let i = 0; i < hexString.length; i += 2) {\r\n  //     let hexDigit = hexString.charAt(i) + hexString.charAt(i + 1);\r\n  //     let num = parseInt(hexDigit, 16);\r\n  //     result += String.fromCharCode(num);\r\n  //   }\r\n  //   return result;\r\n  // }\r\n}\r\n","import { Inject, Injectable, NgZone, OnDestroy, Optional } from '@angular/core';\r\nimport {\r\n  HttpClient,\r\n  HttpErrorResponse,\r\n  HttpHeaders,\r\n  HttpParams\r\n} from '@angular/common/http';\r\nimport {\r\n  combineLatest,\r\n  from,\r\n  Observable,\r\n  of,\r\n  race,\r\n  Subject,\r\n  Subscription,\r\n  throwError\r\n} from 'rxjs';\r\nimport {\r\n  catchError,\r\n  debounceTime,\r\n  delay,\r\n  filter,\r\n  first,\r\n  map,\r\n  switchMap,\r\n  tap\r\n} from 'rxjs/operators';\r\nimport { DOCUMENT } from '@angular/common';\r\n\r\nimport {\r\n  ValidationHandler,\r\n  ValidationParams\r\n} from './token-validation/validation-handler';\r\nimport { UrlHelperService } from './url-helper.service';\r\nimport {\r\n  OAuthErrorEvent,\r\n  OAuthEvent,\r\n  OAuthInfoEvent,\r\n  OAuthSuccessEvent\r\n} from './events';\r\nimport {\r\n  LoginOptions,\r\n  OAuthLogger,\r\n  OAuthStorage,\r\n  OidcDiscoveryDoc,\r\n  ParsedIdToken,\r\n  TokenResponse,\r\n  UserInfo\r\n} from './types';\r\nimport { b64DecodeUnicode, base64UrlEncode } from './base64-helper';\r\nimport { AuthConfig } from './auth.config';\r\nimport { WebHttpUrlEncodingCodec } from './encoder';\r\nimport { HashHandler } from './token-validation/hash-handler';\r\n\r\n/**\r\n * Service for logging in and logging out with\r\n * OIDC and OAuth2. Supports implicit flow and\r\n * password flow.\r\n */\r\n@Injectable()\r\nexport class OAuthService extends AuthConfig implements OnDestroy {\r\n  // Extending AuthConfig ist just for LEGACY reasons\r\n  // to not break existing code.\r\n\r\n  /**\r\n   * The ValidationHandler used to validate received\r\n   * id_tokens.\r\n   */\r\n  public tokenValidationHandler: ValidationHandler;\r\n\r\n  /**\r\n   * @internal\r\n   * Deprecated:  use property events instead\r\n   */\r\n  public discoveryDocumentLoaded = false;\r\n\r\n  /**\r\n   * @internal\r\n   * Deprecated:  use property events instead\r\n   */\r\n  public discoveryDocumentLoaded$: Observable<OidcDiscoveryDoc>;\r\n\r\n  /**\r\n   * Informs about events, like token_received or token_expires.\r\n   * See the string enum EventType for a full list of event types.\r\n   */\r\n  public events: Observable<OAuthEvent>;\r\n\r\n  /**\r\n   * The received (passed around) state, when logging\r\n   * in with implicit flow.\r\n   */\r\n  public state? = '';\r\n\r\n  protected eventsSubject: Subject<OAuthEvent> = new Subject<OAuthEvent>();\r\n  protected discoveryDocumentLoadedSubject: Subject<\r\n    OidcDiscoveryDoc\r\n  > = new Subject<OidcDiscoveryDoc>();\r\n  protected silentRefreshPostMessageEventListener: EventListener;\r\n  protected grantTypesSupported: Array<string> = [];\r\n  protected _storage: OAuthStorage;\r\n  protected accessTokenTimeoutSubscription: Subscription;\r\n  protected idTokenTimeoutSubscription: Subscription;\r\n  protected tokenReceivedSubscription: Subscription;\r\n  protected sessionCheckEventListener: EventListener;\r\n  protected jwksUri: string;\r\n  protected sessionCheckTimer: any;\r\n  protected silentRefreshSubject: string;\r\n  protected inImplicitFlow = false;\r\n\r\n  protected saveNoncesInLocalStorage = false;\r\n  private document: Document;\r\n\r\n  constructor(\r\n    protected ngZone: NgZone,\r\n    protected http: HttpClient,\r\n    @Optional() storage: OAuthStorage,\r\n    @Optional() tokenValidationHandler: ValidationHandler,\r\n    @Optional() protected config: AuthConfig,\r\n    protected urlHelper: UrlHelperService,\r\n    protected logger: OAuthLogger,\r\n    @Optional() protected crypto: HashHandler,\r\n    @Inject(DOCUMENT) document: any\r\n  ) {\r\n    super();\r\n\r\n    this.debug('angular-oauth2-oidc v8-beta');\r\n\r\n    // See https://github.com/manfredsteyer/angular-oauth2-oidc/issues/773 for why this is needed\r\n    this.document = document;\r\n\r\n    this.discoveryDocumentLoaded$ = this.discoveryDocumentLoadedSubject.asObservable();\r\n    this.events = this.eventsSubject.asObservable();\r\n\r\n    if (tokenValidationHandler) {\r\n      this.tokenValidationHandler = tokenValidationHandler;\r\n    }\r\n\r\n    if (config) {\r\n      this.configure(config);\r\n    }\r\n\r\n    try {\r\n      if (storage) {\r\n        this.setStorage(storage);\r\n      } else if (typeof sessionStorage !== 'undefined') {\r\n        this.setStorage(sessionStorage);\r\n      }\r\n    } catch (e) {\r\n      console.error(\r\n        'No OAuthStorage provided and cannot access default (sessionStorage).' +\r\n          'Consider providing a custom OAuthStorage implementation in your module.',\r\n        e\r\n      );\r\n    }\r\n\r\n    // in IE, sessionStorage does not always survive a redirect\r\n    if (\r\n      typeof window !== 'undefined' &&\r\n      typeof window['localStorage'] !== 'undefined'\r\n    ) {\r\n      const ua = window?.navigator?.userAgent;\r\n      const msie = ua?.includes('MSIE ') || ua?.includes('Trident');\r\n\r\n      if (msie) {\r\n        this.saveNoncesInLocalStorage = true;\r\n      }\r\n    }\r\n\r\n    this.setupRefreshTimer();\r\n  }\r\n\r\n  /**\r\n   * Use this method to configure the service\r\n   * @param config the configuration\r\n   */\r\n  public configure(config: AuthConfig): void {\r\n    // For the sake of downward compatibility with\r\n    // original configuration API\r\n    Object.assign(this, new AuthConfig(), config);\r\n\r\n    this.config = Object.assign({} as AuthConfig, new AuthConfig(), config);\r\n\r\n    if (this.sessionChecksEnabled) {\r\n      this.setupSessionCheck();\r\n    }\r\n\r\n    this.configChanged();\r\n  }\r\n\r\n  protected configChanged(): void {\r\n    this.setupRefreshTimer();\r\n  }\r\n\r\n  public restartSessionChecksIfStillLoggedIn(): void {\r\n    if (this.hasValidIdToken()) {\r\n      this.initSessionCheck();\r\n    }\r\n  }\r\n\r\n  protected restartRefreshTimerIfStillLoggedIn(): void {\r\n    this.clearAccessTokenTimer();\r\n    this.clearIdTokenTimer();\r\n    this.setupExpirationTimers();\r\n  }\r\n\r\n  protected setupSessionCheck(): void {\r\n    this.events.pipe(filter(e => e.type === 'token_received')).subscribe(e => {\r\n      this.initSessionCheck();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Will setup up silent refreshing for when the token is\r\n   * about to expire. When the user is logged out via this.logOut method, the\r\n   * silent refreshing will pause and not refresh the tokens until the user is\r\n   * logged back in via receiving a new token.\r\n   * @param params Additional parameter to pass\r\n   * @param listenTo Setup automatic refresh of a specific token type\r\n   */\r\n  public setupAutomaticSilentRefresh(\r\n    params: object = {},\r\n    listenTo?: 'access_token' | 'id_token' | 'any',\r\n    noPrompt = true\r\n  ): void {\r\n    let shouldRunSilentRefresh = true;\r\n    this.events\r\n      .pipe(\r\n        tap(e => {\r\n          if (e.type === 'token_received') {\r\n            shouldRunSilentRefresh = true;\r\n          } else if (e.type === 'logout') {\r\n            shouldRunSilentRefresh = false;\r\n          }\r\n        }),\r\n        filter(e => e.type === 'token_expires'),\r\n        debounceTime(1000)\r\n      )\r\n      .subscribe(e => {\r\n        const event = e as OAuthInfoEvent;\r\n        if (\r\n          (listenTo == null || listenTo === 'any' || event.info === listenTo) &&\r\n          shouldRunSilentRefresh\r\n        ) {\r\n          // this.silentRefresh(params, noPrompt).catch(_ => {\r\n          this.refreshInternal(params, noPrompt).catch(_ => {\r\n            this.debug('Automatic silent refresh did not work');\r\n          });\r\n        }\r\n      });\r\n\r\n    this.restartRefreshTimerIfStillLoggedIn();\r\n  }\r\n\r\n  protected refreshInternal(\r\n    params,\r\n    noPrompt\r\n  ): Promise<TokenResponse | OAuthEvent> {\r\n    if (!this.useSilentRefresh && this.responseType === 'code') {\r\n      return this.refreshToken();\r\n    } else {\r\n      return this.silentRefresh(params, noPrompt);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Convenience method that first calls `loadDiscoveryDocument(...)` and\r\n   * directly chains using the `then(...)` part of the promise to call\r\n   * the `tryLogin(...)` method.\r\n   *\r\n   * @param options LoginOptions to pass through to `tryLogin(...)`\r\n   */\r\n  public loadDiscoveryDocumentAndTryLogin(\r\n    options: LoginOptions = null\r\n  ): Promise<boolean> {\r\n    return this.loadDiscoveryDocument().then(doc => {\r\n      return this.tryLogin(options);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Convenience method that first calls `loadDiscoveryDocumentAndTryLogin(...)`\r\n   * and if then chains to `initLoginFlow()`, but only if there is no valid\r\n   * IdToken or no valid AccessToken.\r\n   *\r\n   * @param options LoginOptions to pass through to `tryLogin(...)`\r\n   */\r\n  public loadDiscoveryDocumentAndLogin(\r\n    options: LoginOptions & { state?: string } = null\r\n  ): Promise<boolean> {\r\n    options = options || {};\r\n    return this.loadDiscoveryDocumentAndTryLogin(options).then(_ => {\r\n      if (!this.hasValidIdToken() || !this.hasValidAccessToken()) {\r\n        const state = typeof options.state === 'string' ? options.state : '';\r\n        this.initLoginFlow(state);\r\n        return false;\r\n      } else {\r\n        return true;\r\n      }\r\n    });\r\n  }\r\n\r\n  protected debug(...args): void {\r\n    if (this.showDebugInformation) {\r\n      this.logger.debug.apply(this.logger, args);\r\n    }\r\n  }\r\n\r\n  protected validateUrlFromDiscoveryDocument(url: string): string[] {\r\n    const errors: string[] = [];\r\n    const httpsCheck = this.validateUrlForHttps(url);\r\n    const issuerCheck = this.validateUrlAgainstIssuer(url);\r\n\r\n    if (!httpsCheck) {\r\n      errors.push(\r\n        'https for all urls required. Also for urls received by discovery.'\r\n      );\r\n    }\r\n\r\n    if (!issuerCheck) {\r\n      errors.push(\r\n        'Every url in discovery document has to start with the issuer url.' +\r\n          'Also see property strictDiscoveryDocumentValidation.'\r\n      );\r\n    }\r\n\r\n    return errors;\r\n  }\r\n\r\n  protected validateUrlForHttps(url: string): boolean {\r\n    if (!url) {\r\n      return true;\r\n    }\r\n\r\n    const lcUrl = url.toLowerCase();\r\n\r\n    if (this.requireHttps === false) {\r\n      return true;\r\n    }\r\n\r\n    if (\r\n      (lcUrl.match(/^http:\\/\\/localhost($|[:\\/])/) ||\r\n        lcUrl.match(/^http:\\/\\/localhost($|[:\\/])/)) &&\r\n      this.requireHttps === 'remoteOnly'\r\n    ) {\r\n      return true;\r\n    }\r\n\r\n    return lcUrl.startsWith('https://');\r\n  }\r\n\r\n  protected assertUrlNotNullAndCorrectProtocol(\r\n    url: string | undefined,\r\n    description: string\r\n  ) {\r\n    if (!url) {\r\n      throw new Error(`'${description}' should not be null`);\r\n    }\r\n    if (!this.validateUrlForHttps(url)) {\r\n      throw new Error(\r\n        `'${description}' must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).`\r\n      );\r\n    }\r\n  }\r\n\r\n  protected validateUrlAgainstIssuer(url: string) {\r\n    if (!this.strictDiscoveryDocumentValidation) {\r\n      return true;\r\n    }\r\n    if (!url) {\r\n      return true;\r\n    }\r\n    return url.toLowerCase().startsWith(this.issuer.toLowerCase());\r\n  }\r\n\r\n  protected setupRefreshTimer(): void {\r\n    if (typeof window === 'undefined') {\r\n      this.debug('timer not supported on this plattform');\r\n      return;\r\n    }\r\n\r\n    if (this.hasValidIdToken() || this.hasValidAccessToken()) {\r\n      this.clearAccessTokenTimer();\r\n      this.clearIdTokenTimer();\r\n      this.setupExpirationTimers();\r\n    }\r\n\r\n    if (this.tokenReceivedSubscription)\r\n      this.tokenReceivedSubscription.unsubscribe();\r\n\r\n    this.tokenReceivedSubscription = this.events\r\n      .pipe(filter(e => e.type === 'token_received'))\r\n      .subscribe(_ => {\r\n        this.clearAccessTokenTimer();\r\n        this.clearIdTokenTimer();\r\n        this.setupExpirationTimers();\r\n      });\r\n  }\r\n\r\n  protected setupExpirationTimers(): void {\r\n    if (this.hasValidAccessToken()) {\r\n      this.setupAccessTokenTimer();\r\n    }\r\n\r\n    if (this.hasValidIdToken()) {\r\n      this.setupIdTokenTimer();\r\n    }\r\n  }\r\n\r\n  protected setupAccessTokenTimer(): void {\r\n    const expiration = this.getAccessTokenExpiration();\r\n    const storedAt = this.getAccessTokenStoredAt();\r\n    const timeout = this.calcTimeout(storedAt, expiration);\r\n\r\n    this.ngZone.runOutsideAngular(() => {\r\n      this.accessTokenTimeoutSubscription = of(\r\n        new OAuthInfoEvent('token_expires', 'access_token')\r\n      )\r\n        .pipe(delay(timeout))\r\n        .subscribe(e => {\r\n          this.ngZone.run(() => {\r\n            this.eventsSubject.next(e);\r\n          });\r\n        });\r\n    });\r\n  }\r\n\r\n  protected setupIdTokenTimer(): void {\r\n    const expiration = this.getIdTokenExpiration();\r\n    const storedAt = this.getIdTokenStoredAt();\r\n    const timeout = this.calcTimeout(storedAt, expiration);\r\n\r\n    this.ngZone.runOutsideAngular(() => {\r\n      this.idTokenTimeoutSubscription = of(\r\n        new OAuthInfoEvent('token_expires', 'id_token')\r\n      )\r\n        .pipe(delay(timeout))\r\n        .subscribe(e => {\r\n          this.ngZone.run(() => {\r\n            this.eventsSubject.next(e);\r\n          });\r\n        });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Stops timers for automatic refresh.\r\n   * To restart it, call setupAutomaticSilentRefresh again.\r\n   */\r\n  public stopAutomaticRefresh() {\r\n    this.clearAccessTokenTimer();\r\n    this.clearIdTokenTimer();\r\n  }\r\n\r\n  protected clearAccessTokenTimer(): void {\r\n    if (this.accessTokenTimeoutSubscription) {\r\n      this.accessTokenTimeoutSubscription.unsubscribe();\r\n    }\r\n  }\r\n\r\n  protected clearIdTokenTimer(): void {\r\n    if (this.idTokenTimeoutSubscription) {\r\n      this.idTokenTimeoutSubscription.unsubscribe();\r\n    }\r\n  }\r\n\r\n  protected calcTimeout(storedAt: number, expiration: number): number {\r\n    const now = Date.now();\r\n    const delta =\r\n      (expiration - storedAt) * this.timeoutFactor - (now - storedAt);\r\n    return Math.max(0, delta);\r\n  }\r\n\r\n  /**\r\n   * DEPRECATED. Use a provider for OAuthStorage instead:\r\n   *\r\n   * { provide: OAuthStorage, useFactory: oAuthStorageFactory }\r\n   * export function oAuthStorageFactory(): OAuthStorage { return localStorage; }\r\n   * Sets a custom storage used to store the received\r\n   * tokens on client side. By default, the browser's\r\n   * sessionStorage is used.\r\n   * @ignore\r\n   *\r\n   * @param storage\r\n   */\r\n  public setStorage(storage: OAuthStorage): void {\r\n    this._storage = storage;\r\n    this.configChanged();\r\n  }\r\n\r\n  /**\r\n   * Loads the discovery document to configure most\r\n   * properties of this service. The url of the discovery\r\n   * document is infered from the issuer's url according\r\n   * to the OpenId Connect spec. To use another url you\r\n   * can pass it to to optional parameter fullUrl.\r\n   *\r\n   * @param fullUrl\r\n   */\r\n  public loadDiscoveryDocument(\r\n    fullUrl: string = null\r\n  ): Promise<OAuthSuccessEvent> {\r\n    return new Promise((resolve, reject) => {\r\n      if (!fullUrl) {\r\n        fullUrl = this.issuer || '';\r\n        if (!fullUrl.endsWith('/')) {\r\n          fullUrl += '/';\r\n        }\r\n        fullUrl += '.well-known/openid-configuration';\r\n      }\r\n\r\n      if (!this.validateUrlForHttps(fullUrl)) {\r\n        reject(\r\n          \"issuer  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).\"\r\n        );\r\n        return;\r\n      }\r\n\r\n      this.http.get<OidcDiscoveryDoc>(fullUrl).subscribe(\r\n        doc => {\r\n          if (!this.validateDiscoveryDocument(doc)) {\r\n            this.eventsSubject.next(\r\n              new OAuthErrorEvent('discovery_document_validation_error', null)\r\n            );\r\n            reject('discovery_document_validation_error');\r\n            return;\r\n          }\r\n\r\n          this.loginUrl = doc.authorization_endpoint;\r\n          this.logoutUrl = doc.end_session_endpoint || this.logoutUrl;\r\n          this.grantTypesSupported = doc.grant_types_supported;\r\n          this.issuer = doc.issuer;\r\n          this.tokenEndpoint = this.tokenEndpoint\r\n            ? this.tokenEndpoint\r\n            : doc.token_endpoint;\r\n          this.userinfoEndpoint =\r\n            doc.userinfo_endpoint || this.userinfoEndpoint;\r\n          this.jwksUri = doc.jwks_uri;\r\n          this.sessionCheckIFrameUrl =\r\n            doc.check_session_iframe || this.sessionCheckIFrameUrl;\r\n\r\n          this.discoveryDocumentLoaded = true;\r\n          this.discoveryDocumentLoadedSubject.next(doc);\r\n          this.revocationEndpoint = doc.revocation_endpoint;\r\n\r\n          if (this.sessionChecksEnabled) {\r\n            this.restartSessionChecksIfStillLoggedIn();\r\n          }\r\n\r\n          this.loadJwks()\r\n            .then(jwks => {\r\n              const result: object = {\r\n                discoveryDocument: doc,\r\n                jwks: jwks\r\n              };\r\n\r\n              const event = new OAuthSuccessEvent(\r\n                'discovery_document_loaded',\r\n                result\r\n              );\r\n              this.eventsSubject.next(event);\r\n              resolve(event);\r\n              return;\r\n            })\r\n            .catch(err => {\r\n              this.eventsSubject.next(\r\n                new OAuthErrorEvent('discovery_document_load_error', err)\r\n              );\r\n              reject(err);\r\n              return;\r\n            });\r\n        },\r\n        err => {\r\n          this.logger.error('error loading discovery document', err);\r\n          this.eventsSubject.next(\r\n            new OAuthErrorEvent('discovery_document_load_error', err)\r\n          );\r\n          reject(err);\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  protected loadJwks(): Promise<object> {\r\n    return new Promise<object>((resolve, reject) => {\r\n      if (this.jwksUri) {\r\n        this.http.get(this.jwksUri).subscribe(\r\n          jwks => {\r\n            this.jwks = jwks;\r\n            this.eventsSubject.next(\r\n              new OAuthSuccessEvent('discovery_document_loaded')\r\n            );\r\n            resolve(jwks);\r\n          },\r\n          err => {\r\n            this.logger.error('error loading jwks', err);\r\n            this.eventsSubject.next(\r\n              new OAuthErrorEvent('jwks_load_error', err)\r\n            );\r\n            reject(err);\r\n          }\r\n        );\r\n      } else {\r\n        resolve(null);\r\n      }\r\n    });\r\n  }\r\n\r\n  protected validateDiscoveryDocument(doc: OidcDiscoveryDoc): boolean {\r\n    let errors: string[];\r\n\r\n    if (!this.skipIssuerCheck && doc.issuer !== this.issuer) {\r\n      this.logger.error(\r\n        'invalid issuer in discovery document',\r\n        'expected: ' + this.issuer,\r\n        'current: ' + doc.issuer\r\n      );\r\n      return false;\r\n    }\r\n\r\n    errors = this.validateUrlFromDiscoveryDocument(doc.authorization_endpoint);\r\n    if (errors.length > 0) {\r\n      this.logger.error(\r\n        'error validating authorization_endpoint in discovery document',\r\n        errors\r\n      );\r\n      return false;\r\n    }\r\n\r\n    errors = this.validateUrlFromDiscoveryDocument(doc.end_session_endpoint);\r\n    if (errors.length > 0) {\r\n      this.logger.error(\r\n        'error validating end_session_endpoint in discovery document',\r\n        errors\r\n      );\r\n      return false;\r\n    }\r\n\r\n    errors = this.validateUrlFromDiscoveryDocument(doc.token_endpoint);\r\n    if (errors.length > 0) {\r\n      this.logger.error(\r\n        'error validating token_endpoint in discovery document',\r\n        errors\r\n      );\r\n    }\r\n\r\n    errors = this.validateUrlFromDiscoveryDocument(doc.revocation_endpoint);\r\n    if (errors.length > 0) {\r\n      this.logger.error(\r\n        'error validating revocation_endpoint in discovery document',\r\n        errors\r\n      );\r\n    }\r\n\r\n    errors = this.validateUrlFromDiscoveryDocument(doc.userinfo_endpoint);\r\n    if (errors.length > 0) {\r\n      this.logger.error(\r\n        'error validating userinfo_endpoint in discovery document',\r\n        errors\r\n      );\r\n      return false;\r\n    }\r\n\r\n    errors = this.validateUrlFromDiscoveryDocument(doc.jwks_uri);\r\n    if (errors.length > 0) {\r\n      this.logger.error(\r\n        'error validating jwks_uri in discovery document',\r\n        errors\r\n      );\r\n      return false;\r\n    }\r\n\r\n    if (this.sessionChecksEnabled && !doc.check_session_iframe) {\r\n      this.logger.warn(\r\n        'sessionChecksEnabled is activated but discovery document' +\r\n          ' does not contain a check_session_iframe field'\r\n      );\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Uses password flow to exchange userName and password for an\r\n   * access_token. After receiving the access_token, this method\r\n   * uses it to query the userinfo endpoint in order to get information\r\n   * about the user in question.\r\n   *\r\n   * When using this, make sure that the property oidc is set to false.\r\n   * Otherwise stricter validations take place that make this operation\r\n   * fail.\r\n   *\r\n   * @param userName\r\n   * @param password\r\n   * @param headers Optional additional http-headers.\r\n   */\r\n  public fetchTokenUsingPasswordFlowAndLoadUserProfile(\r\n    userName: string,\r\n    password: string,\r\n    headers: HttpHeaders = new HttpHeaders()\r\n  ): Promise<UserInfo> {\r\n    return this.fetchTokenUsingPasswordFlow(\r\n      userName,\r\n      password,\r\n      headers\r\n    ).then(() => this.loadUserProfile());\r\n  }\r\n\r\n  /**\r\n   * Loads the user profile by accessing the user info endpoint defined by OpenId Connect.\r\n   *\r\n   * When using this with OAuth2 password flow, make sure that the property oidc is set to false.\r\n   * Otherwise stricter validations take place that make this operation fail.\r\n   */\r\n  public loadUserProfile(): Promise<UserInfo> {\r\n    if (!this.hasValidAccessToken()) {\r\n      throw new Error('Can not load User Profile without access_token');\r\n    }\r\n    if (!this.validateUrlForHttps(this.userinfoEndpoint)) {\r\n      throw new Error(\r\n        \"userinfoEndpoint must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).\"\r\n      );\r\n    }\r\n\r\n    return new Promise((resolve, reject) => {\r\n      const headers = new HttpHeaders().set(\r\n        'Authorization',\r\n        'Bearer ' + this.getAccessToken()\r\n      );\r\n\r\n      this.http\r\n        .get<UserInfo>(this.userinfoEndpoint, { headers })\r\n        .subscribe(\r\n          info => {\r\n            this.debug('userinfo received', info);\r\n\r\n            const existingClaims = this.getIdentityClaims() || {};\r\n\r\n            if (!this.skipSubjectCheck) {\r\n              if (\r\n                this.oidc &&\r\n                (!existingClaims['sub'] || info.sub !== existingClaims['sub'])\r\n              ) {\r\n                const err =\r\n                  'if property oidc is true, the received user-id (sub) has to be the user-id ' +\r\n                  'of the user that has logged in with oidc.\\n' +\r\n                  'if you are not using oidc but just oauth2 password flow set oidc to false';\r\n\r\n                reject(err);\r\n                return;\r\n              }\r\n            }\r\n\r\n            info = Object.assign({}, existingClaims, info);\r\n\r\n            this._storage.setItem('id_token_claims_obj', JSON.stringify(info));\r\n            this.eventsSubject.next(\r\n              new OAuthSuccessEvent('user_profile_loaded')\r\n            );\r\n            resolve(info);\r\n          },\r\n          err => {\r\n            this.logger.error('error loading user info', err);\r\n            this.eventsSubject.next(\r\n              new OAuthErrorEvent('user_profile_load_error', err)\r\n            );\r\n            reject(err);\r\n          }\r\n        );\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Uses password flow to exchange userName and password for an access_token.\r\n   * @param userName\r\n   * @param password\r\n   * @param headers Optional additional http-headers.\r\n   */\r\n  public fetchTokenUsingPasswordFlow(\r\n    userName: string,\r\n    password: string,\r\n    headers: HttpHeaders = new HttpHeaders()\r\n  ): Promise<TokenResponse> {\r\n    this.assertUrlNotNullAndCorrectProtocol(\r\n      this.tokenEndpoint,\r\n      'tokenEndpoint'\r\n    );\r\n\r\n    return new Promise((resolve, reject) => {\r\n      /**\r\n       * A `HttpParameterCodec` that uses `encodeURIComponent` and `decodeURIComponent` to\r\n       * serialize and parse URL parameter keys and values.\r\n       *\r\n       * @stable\r\n       */\r\n      let params = new HttpParams({ encoder: new WebHttpUrlEncodingCodec() })\r\n        .set('grant_type', 'password')\r\n        .set('scope', this.scope)\r\n        .set('username', userName)\r\n        .set('password', password);\r\n\r\n      if (this.useHttpBasicAuth) {\r\n        const header = btoa(`${this.clientId}:${this.dummyClientSecret}`);\r\n        headers = headers.set('Authorization', 'Basic ' + header);\r\n      }\r\n\r\n      if (!this.useHttpBasicAuth) {\r\n        params = params.set('client_id', this.clientId);\r\n      }\r\n\r\n      if (!this.useHttpBasicAuth && this.dummyClientSecret) {\r\n        params = params.set('client_secret', this.dummyClientSecret);\r\n      }\r\n\r\n      if (this.customQueryParams) {\r\n        for (const key of Object.getOwnPropertyNames(this.customQueryParams)) {\r\n          params = params.set(key, this.customQueryParams[key]);\r\n        }\r\n      }\r\n\r\n      headers = headers.set(\r\n        'Content-Type',\r\n        'application/x-www-form-urlencoded'\r\n      );\r\n\r\n      this.http\r\n        .post<TokenResponse>(this.tokenEndpoint, params, { headers })\r\n        .subscribe(\r\n          tokenResponse => {\r\n            this.debug('tokenResponse', tokenResponse);\r\n            this.storeAccessTokenResponse(\r\n              tokenResponse.access_token,\r\n              tokenResponse.refresh_token,\r\n              tokenResponse.expires_in ||\r\n                this.fallbackAccessTokenExpirationTimeInSec,\r\n              tokenResponse.scope,\r\n              this.extractRecognizedCustomParameters(tokenResponse)\r\n            );\r\n\r\n            this.eventsSubject.next(new OAuthSuccessEvent('token_received'));\r\n            resolve(tokenResponse);\r\n          },\r\n          err => {\r\n            this.logger.error('Error performing password flow', err);\r\n            this.eventsSubject.next(new OAuthErrorEvent('token_error', err));\r\n            reject(err);\r\n          }\r\n        );\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Refreshes the token using a refresh_token.\r\n   * This does not work for implicit flow, b/c\r\n   * there is no refresh_token in this flow.\r\n   * A solution for this is provided by the\r\n   * method silentRefresh.\r\n   */\r\n  public refreshToken(): Promise<TokenResponse> {\r\n    this.assertUrlNotNullAndCorrectProtocol(\r\n      this.tokenEndpoint,\r\n      'tokenEndpoint'\r\n    );\r\n\r\n    return new Promise((resolve, reject) => {\r\n      let params = new HttpParams()\r\n        .set('grant_type', 'refresh_token')\r\n        .set('scope', this.scope)\r\n        .set('refresh_token', this._storage.getItem('refresh_token'));\r\n\r\n      let headers = new HttpHeaders().set(\r\n        'Content-Type',\r\n        'application/x-www-form-urlencoded'\r\n      );\r\n\r\n      if (this.useHttpBasicAuth) {\r\n        const header = btoa(`${this.clientId}:${this.dummyClientSecret}`);\r\n        headers = headers.set('Authorization', 'Basic ' + header);\r\n      }\r\n\r\n      if (!this.useHttpBasicAuth) {\r\n        params = params.set('client_id', this.clientId);\r\n      }\r\n\r\n      if (!this.useHttpBasicAuth && this.dummyClientSecret) {\r\n        params = params.set('client_secret', this.dummyClientSecret);\r\n      }\r\n\r\n      if (this.customQueryParams) {\r\n        for (const key of Object.getOwnPropertyNames(this.customQueryParams)) {\r\n          params = params.set(key, this.customQueryParams[key]);\r\n        }\r\n      }\r\n\r\n      this.http\r\n        .post<TokenResponse>(this.tokenEndpoint, params, { headers })\r\n        .pipe(\r\n          switchMap(tokenResponse => {\r\n            if (tokenResponse.id_token) {\r\n              return from(\r\n                this.processIdToken(\r\n                  tokenResponse.id_token,\r\n                  tokenResponse.access_token,\r\n                  true\r\n                )\r\n              ).pipe(\r\n                tap(result => this.storeIdToken(result)),\r\n                map(_ => tokenResponse)\r\n              );\r\n            } else {\r\n              return of(tokenResponse);\r\n            }\r\n          })\r\n        )\r\n        .subscribe(\r\n          tokenResponse => {\r\n            this.debug('refresh tokenResponse', tokenResponse);\r\n            this.storeAccessTokenResponse(\r\n              tokenResponse.access_token,\r\n              tokenResponse.refresh_token,\r\n              tokenResponse.expires_in ||\r\n                this.fallbackAccessTokenExpirationTimeInSec,\r\n              tokenResponse.scope,\r\n              this.extractRecognizedCustomParameters(tokenResponse)\r\n            );\r\n\r\n            this.eventsSubject.next(new OAuthSuccessEvent('token_received'));\r\n            this.eventsSubject.next(new OAuthSuccessEvent('token_refreshed'));\r\n            resolve(tokenResponse);\r\n          },\r\n          err => {\r\n            this.logger.error('Error refreshing token', err);\r\n            this.eventsSubject.next(\r\n              new OAuthErrorEvent('token_refresh_error', err)\r\n            );\r\n            reject(err);\r\n          }\r\n        );\r\n    });\r\n  }\r\n\r\n  protected removeSilentRefreshEventListener(): void {\r\n    if (this.silentRefreshPostMessageEventListener) {\r\n      window.removeEventListener(\r\n        'message',\r\n        this.silentRefreshPostMessageEventListener\r\n      );\r\n      this.silentRefreshPostMessageEventListener = null;\r\n    }\r\n  }\r\n\r\n  protected setupSilentRefreshEventListener(): void {\r\n    this.removeSilentRefreshEventListener();\r\n\r\n    this.silentRefreshPostMessageEventListener = (e: MessageEvent) => {\r\n      const message = this.processMessageEventMessage(e);\r\n\r\n      this.tryLogin({\r\n        customHashFragment: message,\r\n        preventClearHashAfterLogin: true,\r\n        customRedirectUri: this.silentRefreshRedirectUri || this.redirectUri\r\n      }).catch(err => this.debug('tryLogin during silent refresh failed', err));\r\n    };\r\n\r\n    window.addEventListener(\r\n      'message',\r\n      this.silentRefreshPostMessageEventListener\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Performs a silent refresh for implicit flow.\r\n   * Use this method to get new tokens when/before\r\n   * the existing tokens expire.\r\n   */\r\n  public silentRefresh(\r\n    params: object = {},\r\n    noPrompt = true\r\n  ): Promise<OAuthEvent> {\r\n    const claims: object = this.getIdentityClaims() || {};\r\n\r\n    if (this.useIdTokenHintForSilentRefresh && this.hasValidIdToken()) {\r\n      params['id_token_hint'] = this.getIdToken();\r\n    }\r\n\r\n    if (!this.validateUrlForHttps(this.loginUrl)) {\r\n      throw new Error(\r\n        \"loginUrl  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).\"\r\n      );\r\n    }\r\n\r\n    if (typeof this.document === 'undefined') {\r\n      throw new Error('silent refresh is not supported on this platform');\r\n    }\r\n\r\n    const existingIframe = this.document.getElementById(\r\n      this.silentRefreshIFrameName\r\n    );\r\n\r\n    if (existingIframe) {\r\n      this.document.body.removeChild(existingIframe);\r\n    }\r\n\r\n    this.silentRefreshSubject = claims['sub'];\r\n\r\n    const iframe = this.document.createElement('iframe');\r\n    iframe.id = this.silentRefreshIFrameName;\r\n\r\n    this.setupSilentRefreshEventListener();\r\n\r\n    const redirectUri = this.silentRefreshRedirectUri || this.redirectUri;\r\n    this.createLoginUrl(null, null, redirectUri, noPrompt, params).then(url => {\r\n      iframe.setAttribute('src', url);\r\n\r\n      if (!this.silentRefreshShowIFrame) {\r\n        iframe.style['display'] = 'none';\r\n      }\r\n      this.document.body.appendChild(iframe);\r\n    });\r\n\r\n    const errors = this.events.pipe(\r\n      filter(e => e instanceof OAuthErrorEvent),\r\n      first()\r\n    );\r\n    const success = this.events.pipe(\r\n      filter(e => e.type === 'token_received'),\r\n      first()\r\n    );\r\n    const timeout = of(\r\n      new OAuthErrorEvent('silent_refresh_timeout', null)\r\n    ).pipe(delay(this.silentRefreshTimeout));\r\n\r\n    return race([errors, success, timeout])\r\n      .pipe(\r\n        map(e => {\r\n          if (e instanceof OAuthErrorEvent) {\r\n            if (e.type === 'silent_refresh_timeout') {\r\n              this.eventsSubject.next(e);\r\n            } else {\r\n              e = new OAuthErrorEvent('silent_refresh_error', e);\r\n              this.eventsSubject.next(e);\r\n            }\r\n            throw e;\r\n          } else if (e.type === 'token_received') {\r\n            e = new OAuthSuccessEvent('silently_refreshed');\r\n            this.eventsSubject.next(e);\r\n          }\r\n          return e;\r\n        })\r\n      )\r\n      .toPromise();\r\n  }\r\n\r\n  /**\r\n   * This method exists for backwards compatibility.\r\n   * {@link OAuthService#initLoginFlowInPopup} handles both code\r\n   * and implicit flows.\r\n   */\r\n  public initImplicitFlowInPopup(options?: {\r\n    height?: number;\r\n    width?: number;\r\n  }) {\r\n    return this.initLoginFlowInPopup(options);\r\n  }\r\n\r\n  public initLoginFlowInPopup(options?: { height?: number; width?: number }) {\r\n    options = options || {};\r\n    return this.createLoginUrl(\r\n      null,\r\n      null,\r\n      this.silentRefreshRedirectUri,\r\n      false,\r\n      {\r\n        display: 'popup'\r\n      }\r\n    ).then(url => {\r\n      return new Promise((resolve, reject) => {\r\n        /**\r\n         * Error handling section\r\n         */\r\n        const checkForPopupClosedInterval = 500;\r\n        let windowRef = window.open(\r\n          url,\r\n          '_blank',\r\n          this.calculatePopupFeatures(options)\r\n        );\r\n        let checkForPopupClosedTimer: any;\r\n        const checkForPopupClosed = () => {\r\n          if (!windowRef || windowRef.closed) {\r\n            cleanup();\r\n            reject(new OAuthErrorEvent('popup_closed', {}));\r\n          }\r\n        };\r\n        if (!windowRef) {\r\n          reject(new OAuthErrorEvent('popup_blocked', {}));\r\n        } else {\r\n          checkForPopupClosedTimer = window.setInterval(\r\n            checkForPopupClosed,\r\n            checkForPopupClosedInterval\r\n          );\r\n        }\r\n\r\n        const cleanup = () => {\r\n          window.clearInterval(checkForPopupClosedTimer);\r\n          window.removeEventListener('message', listener);\r\n          if (windowRef !== null) {\r\n            windowRef.close();\r\n          }\r\n          windowRef = null;\r\n        };\r\n\r\n        const listener = (e: MessageEvent) => {\r\n          const message = this.processMessageEventMessage(e);\r\n\r\n          if (message && message !== null) {\r\n            this.tryLogin({\r\n              customHashFragment: message,\r\n              preventClearHashAfterLogin: true,\r\n              customRedirectUri: this.silentRefreshRedirectUri\r\n            }).then(\r\n              () => {\r\n                cleanup();\r\n                resolve();\r\n              },\r\n              err => {\r\n                cleanup();\r\n                reject(err);\r\n              }\r\n            );\r\n          } else {\r\n            console.log('false event firing');\r\n          }\r\n        };\r\n\r\n        window.addEventListener('message', listener);\r\n      });\r\n    });\r\n  }\r\n\r\n  protected calculatePopupFeatures(options: {\r\n    height?: number;\r\n    width?: number;\r\n  }): string {\r\n    // Specify an static height and width and calculate centered position\r\n\r\n    const height = options.height || 470;\r\n    const width = options.width || 500;\r\n    const left = window.screenLeft + (window.outerWidth - width) / 2;\r\n    const top = window.screenTop + (window.outerHeight - height) / 2;\r\n    return `location=no,toolbar=no,width=${width},height=${height},top=${top},left=${left}`;\r\n  }\r\n\r\n  protected processMessageEventMessage(e: MessageEvent): string {\r\n    let expectedPrefix = '#';\r\n\r\n    if (this.silentRefreshMessagePrefix) {\r\n      expectedPrefix += this.silentRefreshMessagePrefix;\r\n    }\r\n\r\n    if (!e || !e.data || typeof e.data !== 'string') {\r\n      return;\r\n    }\r\n\r\n    const prefixedMessage: string = e.data;\r\n\r\n    if (!prefixedMessage.startsWith(expectedPrefix)) {\r\n      return;\r\n    }\r\n\r\n    return '#' + prefixedMessage.substr(expectedPrefix.length);\r\n  }\r\n\r\n  protected canPerformSessionCheck(): boolean {\r\n    if (!this.sessionChecksEnabled) {\r\n      return false;\r\n    }\r\n    if (!this.sessionCheckIFrameUrl) {\r\n      console.warn(\r\n        'sessionChecksEnabled is activated but there is no sessionCheckIFrameUrl'\r\n      );\r\n      return false;\r\n    }\r\n    const sessionState = this.getSessionState();\r\n    if (!sessionState) {\r\n      console.warn(\r\n        'sessionChecksEnabled is activated but there is no session_state'\r\n      );\r\n      return false;\r\n    }\r\n    if (typeof this.document === 'undefined') {\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  protected setupSessionCheckEventListener(): void {\r\n    this.removeSessionCheckEventListener();\r\n\r\n    this.sessionCheckEventListener = (e: MessageEvent) => {\r\n      const origin = e.origin.toLowerCase();\r\n      const issuer = this.issuer.toLowerCase();\r\n\r\n      this.debug('sessionCheckEventListener');\r\n\r\n      if (!issuer.startsWith(origin)) {\r\n        this.debug(\r\n          'sessionCheckEventListener',\r\n          'wrong origin',\r\n          origin,\r\n          'expected',\r\n          issuer,\r\n          'event',\r\n          e\r\n        );\r\n\r\n        return;\r\n      }\r\n\r\n      // only run in Angular zone if it is 'changed' or 'error'\r\n      switch (e.data) {\r\n        case 'unchanged':\r\n          this.handleSessionUnchanged();\r\n          break;\r\n        case 'changed':\r\n          this.ngZone.run(() => {\r\n            this.handleSessionChange();\r\n          });\r\n          break;\r\n        case 'error':\r\n          this.ngZone.run(() => {\r\n            this.handleSessionError();\r\n          });\r\n          break;\r\n      }\r\n\r\n      this.debug('got info from session check inframe', e);\r\n    };\r\n\r\n    // prevent Angular from refreshing the view on every message (runs in intervals)\r\n    this.ngZone.runOutsideAngular(() => {\r\n      window.addEventListener('message', this.sessionCheckEventListener);\r\n    });\r\n  }\r\n\r\n  protected handleSessionUnchanged(): void {\r\n    this.debug('session check', 'session unchanged');\r\n  }\r\n\r\n  protected handleSessionChange(): void {\r\n    this.eventsSubject.next(new OAuthInfoEvent('session_changed'));\r\n    this.stopSessionCheckTimer();\r\n\r\n    if (!this.useSilentRefresh && this.responseType === 'code') {\r\n      this.refreshToken()\r\n        .then(_ => {\r\n          this.debug('token refresh after session change worked');\r\n        })\r\n        .catch(_ => {\r\n          this.debug('token refresh did not work after session changed');\r\n          this.eventsSubject.next(new OAuthInfoEvent('session_terminated'));\r\n          this.logOut(true);\r\n        });\r\n    } else if (this.silentRefreshRedirectUri) {\r\n      this.silentRefresh().catch(_ =>\r\n        this.debug('silent refresh failed after session changed')\r\n      );\r\n      this.waitForSilentRefreshAfterSessionChange();\r\n    } else {\r\n      this.eventsSubject.next(new OAuthInfoEvent('session_terminated'));\r\n      this.logOut(true);\r\n    }\r\n  }\r\n\r\n  protected waitForSilentRefreshAfterSessionChange(): void {\r\n    this.events\r\n      .pipe(\r\n        filter(\r\n          (e: OAuthEvent) =>\r\n            e.type === 'silently_refreshed' ||\r\n            e.type === 'silent_refresh_timeout' ||\r\n            e.type === 'silent_refresh_error'\r\n        ),\r\n        first()\r\n      )\r\n      .subscribe(e => {\r\n        if (e.type !== 'silently_refreshed') {\r\n          this.debug('silent refresh did not work after session changed');\r\n          this.eventsSubject.next(new OAuthInfoEvent('session_terminated'));\r\n          this.logOut(true);\r\n        }\r\n      });\r\n  }\r\n\r\n  protected handleSessionError(): void {\r\n    this.stopSessionCheckTimer();\r\n    this.eventsSubject.next(new OAuthInfoEvent('session_error'));\r\n  }\r\n\r\n  protected removeSessionCheckEventListener(): void {\r\n    if (this.sessionCheckEventListener) {\r\n      window.removeEventListener('message', this.sessionCheckEventListener);\r\n      this.sessionCheckEventListener = null;\r\n    }\r\n  }\r\n\r\n  protected initSessionCheck(): void {\r\n    if (!this.canPerformSessionCheck()) {\r\n      return;\r\n    }\r\n\r\n    const existingIframe = this.document.getElementById(\r\n      this.sessionCheckIFrameName\r\n    );\r\n    if (existingIframe) {\r\n      this.document.body.removeChild(existingIframe);\r\n    }\r\n\r\n    const iframe = this.document.createElement('iframe');\r\n    iframe.id = this.sessionCheckIFrameName;\r\n\r\n    this.setupSessionCheckEventListener();\r\n\r\n    const url = this.sessionCheckIFrameUrl;\r\n    iframe.setAttribute('src', url);\r\n    iframe.style.display = 'none';\r\n    this.document.body.appendChild(iframe);\r\n\r\n    this.startSessionCheckTimer();\r\n  }\r\n\r\n  protected startSessionCheckTimer(): void {\r\n    this.stopSessionCheckTimer();\r\n    this.ngZone.runOutsideAngular(() => {\r\n      this.sessionCheckTimer = setInterval(\r\n        this.checkSession.bind(this),\r\n        this.sessionCheckIntervall\r\n      );\r\n    });\r\n  }\r\n\r\n  protected stopSessionCheckTimer(): void {\r\n    if (this.sessionCheckTimer) {\r\n      clearInterval(this.sessionCheckTimer);\r\n      this.sessionCheckTimer = null;\r\n    }\r\n  }\r\n\r\n  public checkSession(): void {\r\n    const iframe: any = this.document.getElementById(\r\n      this.sessionCheckIFrameName\r\n    );\r\n\r\n    if (!iframe) {\r\n      this.logger.warn(\r\n        'checkSession did not find iframe',\r\n        this.sessionCheckIFrameName\r\n      );\r\n    }\r\n\r\n    const sessionState = this.getSessionState();\r\n\r\n    if (!sessionState) {\r\n      this.stopSessionCheckTimer();\r\n    }\r\n\r\n    const message = this.clientId + ' ' + sessionState;\r\n    iframe.contentWindow.postMessage(message, this.issuer);\r\n  }\r\n\r\n  protected async createLoginUrl(\r\n    state = '',\r\n    loginHint = '',\r\n    customRedirectUri = '',\r\n    noPrompt = false,\r\n    params: object = {}\r\n  ): Promise<string> {\r\n    const that = this;\r\n\r\n    let redirectUri: string;\r\n\r\n    if (customRedirectUri) {\r\n      redirectUri = customRedirectUri;\r\n    } else {\r\n      redirectUri = this.redirectUri;\r\n    }\r\n\r\n    const nonce = await this.createAndSaveNonce();\r\n\r\n    if (state) {\r\n      state =\r\n        nonce + this.config.nonceStateSeparator + encodeURIComponent(state);\r\n    } else {\r\n      state = nonce;\r\n    }\r\n\r\n    if (!this.requestAccessToken && !this.oidc) {\r\n      throw new Error('Either requestAccessToken or oidc or both must be true');\r\n    }\r\n\r\n    if (this.config.responseType) {\r\n      this.responseType = this.config.responseType;\r\n    } else {\r\n      if (this.oidc && this.requestAccessToken) {\r\n        this.responseType = 'id_token token';\r\n      } else if (this.oidc && !this.requestAccessToken) {\r\n        this.responseType = 'id_token';\r\n      } else {\r\n        this.responseType = 'token';\r\n      }\r\n    }\r\n\r\n    const seperationChar = that.loginUrl.indexOf('?') > -1 ? '&' : '?';\r\n\r\n    let scope = that.scope;\r\n\r\n    if (this.oidc && !scope.match(/(^|\\s)openid($|\\s)/)) {\r\n      scope = 'openid ' + scope;\r\n    }\r\n\r\n    let url =\r\n      that.loginUrl +\r\n      seperationChar +\r\n      'response_type=' +\r\n      encodeURIComponent(that.responseType) +\r\n      '&client_id=' +\r\n      encodeURIComponent(that.clientId) +\r\n      '&state=' +\r\n      encodeURIComponent(state) +\r\n      '&redirect_uri=' +\r\n      encodeURIComponent(redirectUri) +\r\n      '&scope=' +\r\n      encodeURIComponent(scope);\r\n\r\n    if (this.responseType.includes('code') && !this.disablePKCE) {\r\n      const [\r\n        challenge,\r\n        verifier\r\n      ] = await this.createChallangeVerifierPairForPKCE();\r\n\r\n      if (\r\n        this.saveNoncesInLocalStorage &&\r\n        typeof window['localStorage'] !== 'undefined'\r\n      ) {\r\n        localStorage.setItem('PKCE_verifier', verifier);\r\n      } else {\r\n        this._storage.setItem('PKCE_verifier', verifier);\r\n      }\r\n\r\n      url += '&code_challenge=' + challenge;\r\n      url += '&code_challenge_method=S256';\r\n    }\r\n\r\n    if (loginHint) {\r\n      url += '&login_hint=' + encodeURIComponent(loginHint);\r\n    }\r\n\r\n    if (that.resource) {\r\n      url += '&resource=' + encodeURIComponent(that.resource);\r\n    }\r\n\r\n    if (that.oidc) {\r\n      url += '&nonce=' + encodeURIComponent(nonce);\r\n    }\r\n\r\n    if (noPrompt) {\r\n      url += '&prompt=none';\r\n    }\r\n\r\n    for (const key of Object.keys(params)) {\r\n      url +=\r\n        '&' + encodeURIComponent(key) + '=' + encodeURIComponent(params[key]);\r\n    }\r\n\r\n    if (this.customQueryParams) {\r\n      for (const key of Object.getOwnPropertyNames(this.customQueryParams)) {\r\n        url +=\r\n          '&' + key + '=' + encodeURIComponent(this.customQueryParams[key]);\r\n      }\r\n    }\r\n\r\n    return url;\r\n  }\r\n\r\n  initImplicitFlowInternal(\r\n    additionalState = '',\r\n    params: string | object = ''\r\n  ): void {\r\n    if (this.inImplicitFlow) {\r\n      return;\r\n    }\r\n\r\n    this.inImplicitFlow = true;\r\n\r\n    if (!this.validateUrlForHttps(this.loginUrl)) {\r\n      throw new Error(\r\n        \"loginUrl  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).\"\r\n      );\r\n    }\r\n\r\n    let addParams: object = {};\r\n    let loginHint: string = null;\r\n\r\n    if (typeof params === 'string') {\r\n      loginHint = params;\r\n    } else if (typeof params === 'object') {\r\n      addParams = params;\r\n    }\r\n\r\n    this.createLoginUrl(additionalState, loginHint, null, false, addParams)\r\n      .then(this.config.openUri)\r\n      .catch(error => {\r\n        console.error('Error in initImplicitFlow', error);\r\n        this.inImplicitFlow = false;\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Starts the implicit flow and redirects to user to\r\n   * the auth servers' login url.\r\n   *\r\n   * @param additionalState Optional state that is passed around.\r\n   *  You'll find this state in the property `state` after `tryLogin` logged in the user.\r\n   * @param params Hash with additional parameter. If it is a string, it is used for the\r\n   *               parameter loginHint (for the sake of compatibility with former versions)\r\n   */\r\n  public initImplicitFlow(\r\n    additionalState = '',\r\n    params: string | object = ''\r\n  ): void {\r\n    if (this.loginUrl !== '') {\r\n      this.initImplicitFlowInternal(additionalState, params);\r\n    } else {\r\n      this.events\r\n        .pipe(filter(e => e.type === 'discovery_document_loaded'))\r\n        .subscribe(_ => this.initImplicitFlowInternal(additionalState, params));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Reset current implicit flow\r\n   *\r\n   * @description This method allows resetting the current implict flow in order to be initialized again.\r\n   */\r\n  public resetImplicitFlow(): void {\r\n    this.inImplicitFlow = false;\r\n  }\r\n\r\n  protected callOnTokenReceivedIfExists(options: LoginOptions): void {\r\n    const that = this;\r\n    if (options.onTokenReceived) {\r\n      const tokenParams = {\r\n        idClaims: that.getIdentityClaims(),\r\n        idToken: that.getIdToken(),\r\n        accessToken: that.getAccessToken(),\r\n        state: that.state\r\n      };\r\n      options.onTokenReceived(tokenParams);\r\n    }\r\n  }\r\n\r\n  protected storeAccessTokenResponse(\r\n    accessToken: string,\r\n    refreshToken: string,\r\n    expiresIn: number,\r\n    grantedScopes: String,\r\n    customParameters?: Map<string, string>\r\n  ): void {\r\n    this._storage.setItem('access_token', accessToken);\r\n    if (grantedScopes && !Array.isArray(grantedScopes)) {\r\n      this._storage.setItem(\r\n        'granted_scopes',\r\n        JSON.stringify(grantedScopes.split('+'))\r\n      );\r\n    } else if (grantedScopes && Array.isArray(grantedScopes)) {\r\n      this._storage.setItem('granted_scopes', JSON.stringify(grantedScopes));\r\n    }\r\n\r\n    this._storage.setItem('access_token_stored_at', '' + Date.now());\r\n    if (expiresIn) {\r\n      const expiresInMilliSeconds = expiresIn * 1000;\r\n      const now = new Date();\r\n      const expiresAt = now.getTime() + expiresInMilliSeconds;\r\n      this._storage.setItem('expires_at', '' + expiresAt);\r\n    }\r\n\r\n    if (refreshToken) {\r\n      this._storage.setItem('refresh_token', refreshToken);\r\n    }\r\n    if (customParameters) {\r\n      customParameters.forEach((value: string, key: string) => {\r\n        this._storage.setItem(key, value);\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Delegates to tryLoginImplicitFlow for the sake of competability\r\n   * @param options Optional options.\r\n   */\r\n  public tryLogin(options: LoginOptions = null): Promise<boolean> {\r\n    if (this.config.responseType === 'code') {\r\n      return this.tryLoginCodeFlow(options).then(_ => true);\r\n    } else {\r\n      return this.tryLoginImplicitFlow(options);\r\n    }\r\n  }\r\n\r\n  private parseQueryString(queryString: string): object {\r\n    if (!queryString || queryString.length === 0) {\r\n      return {};\r\n    }\r\n\r\n    if (queryString.charAt(0) === '?') {\r\n      queryString = queryString.substr(1);\r\n    }\r\n\r\n    return this.urlHelper.parseQueryString(queryString);\r\n  }\r\n\r\n  public tryLoginCodeFlow(options: LoginOptions = null): Promise<void> {\r\n    options = options || {};\r\n\r\n    const querySource = options.customHashFragment\r\n      ? options.customHashFragment.substring(1)\r\n      : window.location.search;\r\n\r\n    const parts = this.getCodePartsFromUrl(querySource);\r\n\r\n    const code = parts['code'];\r\n    const state = parts['state'];\r\n\r\n    const sessionState = parts['session_state'];\r\n\r\n    if (!options.preventClearHashAfterLogin) {\r\n      const href = location.href\r\n        .replace(/[&\\?]code=[^&\\$]*/, '')\r\n        .replace(/[&\\?]scope=[^&\\$]*/, '')\r\n        .replace(/[&\\?]state=[^&\\$]*/, '')\r\n        .replace(/[&\\?]session_state=[^&\\$]*/, '');\r\n\r\n      history.replaceState(null, window.name, href);\r\n    }\r\n\r\n    let [nonceInState, userState] = this.parseState(state);\r\n    this.state = userState;\r\n\r\n    if (parts['error']) {\r\n      this.debug('error trying to login');\r\n      this.handleLoginError({}, parts);\r\n      const err = new OAuthErrorEvent('code_error', {}, parts);\r\n      this.eventsSubject.next(err);\r\n      return Promise.reject(err);\r\n    }\r\n\r\n    if (!nonceInState) {\r\n      return Promise.resolve();\r\n    }\r\n\r\n    const success = this.validateNonce(nonceInState);\r\n    if (!success) {\r\n      const event = new OAuthErrorEvent('invalid_nonce_in_state', null);\r\n      this.eventsSubject.next(event);\r\n      return Promise.reject(event);\r\n    }\r\n\r\n    this.storeSessionState(sessionState);\r\n\r\n    if (code) {\r\n      return this.getTokenFromCode(code, options).then(_ => null);\r\n    } else {\r\n      return Promise.resolve();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Retrieve the returned auth code from the redirect uri that has been called.\r\n   * If required also check hash, as we could use hash location strategy.\r\n   */\r\n  private getCodePartsFromUrl(queryString: string): object {\r\n    if (!queryString || queryString.length === 0) {\r\n      return this.urlHelper.getHashFragmentParams();\r\n    }\r\n\r\n    // normalize query string\r\n    if (queryString.charAt(0) === '?') {\r\n      queryString = queryString.substr(1);\r\n    }\r\n\r\n    return this.urlHelper.parseQueryString(queryString);\r\n  }\r\n\r\n  /**\r\n   * Get token using an intermediate code. Works for the Authorization Code flow.\r\n   */\r\n  private getTokenFromCode(\r\n    code: string,\r\n    options: LoginOptions\r\n  ): Promise<object> {\r\n    let params = new HttpParams()\r\n      .set('grant_type', 'authorization_code')\r\n      .set('code', code)\r\n      .set('redirect_uri', options.customRedirectUri || this.redirectUri);\r\n\r\n    if (!this.disablePKCE) {\r\n      let PKCEVerifier;\r\n\r\n      if (\r\n        this.saveNoncesInLocalStorage &&\r\n        typeof window['localStorage'] !== 'undefined'\r\n      ) {\r\n        PKCEVerifier = localStorage.getItem('PKCE_verifier');\r\n      } else {\r\n        PKCEVerifier = this._storage.getItem('PKCE_verifier');\r\n      }\r\n\r\n      if (!PKCEVerifier) {\r\n        console.warn('No PKCE verifier found in oauth storage!');\r\n      } else {\r\n        params = params.set('code_verifier', PKCEVerifier);\r\n      }\r\n    }\r\n\r\n    return this.fetchAndProcessToken(params);\r\n  }\r\n\r\n  private fetchAndProcessToken(params: HttpParams): Promise<TokenResponse> {\r\n    this.assertUrlNotNullAndCorrectProtocol(\r\n      this.tokenEndpoint,\r\n      'tokenEndpoint'\r\n    );\r\n    let headers = new HttpHeaders().set(\r\n      'Content-Type',\r\n      'application/x-www-form-urlencoded'\r\n    );\r\n\r\n    if (this.useHttpBasicAuth) {\r\n      const header = btoa(`${this.clientId}:${this.dummyClientSecret}`);\r\n      headers = headers.set('Authorization', 'Basic ' + header);\r\n    }\r\n\r\n    if (!this.useHttpBasicAuth) {\r\n      params = params.set('client_id', this.clientId);\r\n    }\r\n\r\n    if (!this.useHttpBasicAuth && this.dummyClientSecret) {\r\n      params = params.set('client_secret', this.dummyClientSecret);\r\n    }\r\n\r\n    return new Promise((resolve, reject) => {\r\n      if (this.customQueryParams) {\r\n        for (let key of Object.getOwnPropertyNames(this.customQueryParams)) {\r\n          params = params.set(key, this.customQueryParams[key]);\r\n        }\r\n      }\r\n\r\n      this.http\r\n        .post<TokenResponse>(this.tokenEndpoint, params, { headers })\r\n        .subscribe(\r\n          tokenResponse => {\r\n            this.debug('refresh tokenResponse', tokenResponse);\r\n            this.storeAccessTokenResponse(\r\n              tokenResponse.access_token,\r\n              tokenResponse.refresh_token,\r\n              tokenResponse.expires_in ||\r\n                this.fallbackAccessTokenExpirationTimeInSec,\r\n              tokenResponse.scope,\r\n              this.extractRecognizedCustomParameters(tokenResponse)\r\n            );\r\n\r\n            if (this.oidc && tokenResponse.id_token) {\r\n              this.processIdToken(\r\n                tokenResponse.id_token,\r\n                tokenResponse.access_token\r\n              )\r\n                .then(result => {\r\n                  this.storeIdToken(result);\r\n\r\n                  this.eventsSubject.next(\r\n                    new OAuthSuccessEvent('token_received')\r\n                  );\r\n                  this.eventsSubject.next(\r\n                    new OAuthSuccessEvent('token_refreshed')\r\n                  );\r\n\r\n                  resolve(tokenResponse);\r\n                })\r\n                .catch(reason => {\r\n                  this.eventsSubject.next(\r\n                    new OAuthErrorEvent('token_validation_error', reason)\r\n                  );\r\n                  console.error('Error validating tokens');\r\n                  console.error(reason);\r\n\r\n                  reject(reason);\r\n                });\r\n            } else {\r\n              this.eventsSubject.next(new OAuthSuccessEvent('token_received'));\r\n              this.eventsSubject.next(new OAuthSuccessEvent('token_refreshed'));\r\n\r\n              resolve(tokenResponse);\r\n            }\r\n          },\r\n          err => {\r\n            console.error('Error getting token', err);\r\n            this.eventsSubject.next(\r\n              new OAuthErrorEvent('token_refresh_error', err)\r\n            );\r\n            reject(err);\r\n          }\r\n        );\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Checks whether there are tokens in the hash fragment\r\n   * as a result of the implicit flow. These tokens are\r\n   * parsed, validated and used to sign the user in to the\r\n   * current client.\r\n   *\r\n   * @param options Optional options.\r\n   */\r\n  public tryLoginImplicitFlow(options: LoginOptions = null): Promise<boolean> {\r\n    options = options || {};\r\n\r\n    let parts: object;\r\n\r\n    if (options.customHashFragment) {\r\n      parts = this.urlHelper.getHashFragmentParams(options.customHashFragment);\r\n    } else {\r\n      parts = this.urlHelper.getHashFragmentParams();\r\n    }\r\n\r\n    this.debug('parsed url', parts);\r\n\r\n    const state = parts['state'];\r\n\r\n    let [nonceInState, userState] = this.parseState(state);\r\n    this.state = userState;\r\n\r\n    if (parts['error']) {\r\n      this.debug('error trying to login');\r\n      this.handleLoginError(options, parts);\r\n      const err = new OAuthErrorEvent('token_error', {}, parts);\r\n      this.eventsSubject.next(err);\r\n      return Promise.reject(err);\r\n    }\r\n\r\n    const accessToken = parts['access_token'];\r\n    const idToken = parts['id_token'];\r\n    const sessionState = parts['session_state'];\r\n    const grantedScopes = parts['scope'];\r\n\r\n    if (!this.requestAccessToken && !this.oidc) {\r\n      return Promise.reject(\r\n        'Either requestAccessToken or oidc (or both) must be true.'\r\n      );\r\n    }\r\n\r\n    if (this.requestAccessToken && !accessToken) {\r\n      return Promise.resolve(false);\r\n    }\r\n    if (this.requestAccessToken && !options.disableOAuth2StateCheck && !state) {\r\n      return Promise.resolve(false);\r\n    }\r\n    if (this.oidc && !idToken) {\r\n      return Promise.resolve(false);\r\n    }\r\n\r\n    if (this.sessionChecksEnabled && !sessionState) {\r\n      this.logger.warn(\r\n        'session checks (Session Status Change Notification) ' +\r\n          'were activated in the configuration but the id_token ' +\r\n          'does not contain a session_state claim'\r\n      );\r\n    }\r\n\r\n    if (this.requestAccessToken && !options.disableOAuth2StateCheck) {\r\n      const success = this.validateNonce(nonceInState);\r\n\r\n      if (!success) {\r\n        const event = new OAuthErrorEvent('invalid_nonce_in_state', null);\r\n        this.eventsSubject.next(event);\r\n        return Promise.reject(event);\r\n      }\r\n    }\r\n\r\n    if (this.requestAccessToken) {\r\n      this.storeAccessTokenResponse(\r\n        accessToken,\r\n        null,\r\n        parts['expires_in'] || this.fallbackAccessTokenExpirationTimeInSec,\r\n        grantedScopes\r\n      );\r\n    }\r\n\r\n    if (!this.oidc) {\r\n      this.eventsSubject.next(new OAuthSuccessEvent('token_received'));\r\n      if (this.clearHashAfterLogin && !options.preventClearHashAfterLogin) {\r\n        location.hash = '';\r\n      }\r\n\r\n      this.callOnTokenReceivedIfExists(options);\r\n      return Promise.resolve(true);\r\n    }\r\n\r\n    return this.processIdToken(idToken, accessToken)\r\n      .then(result => {\r\n        if (options.validationHandler) {\r\n          return options\r\n            .validationHandler({\r\n              accessToken: accessToken,\r\n              idClaims: result.idTokenClaims,\r\n              idToken: result.idToken,\r\n              state: state\r\n            })\r\n            .then(_ => result);\r\n        }\r\n        return result;\r\n      })\r\n      .then(result => {\r\n        this.storeIdToken(result);\r\n        this.storeSessionState(sessionState);\r\n        if (this.clearHashAfterLogin && !options.preventClearHashAfterLogin) {\r\n          location.hash = '';\r\n        }\r\n        this.eventsSubject.next(new OAuthSuccessEvent('token_received'));\r\n        this.callOnTokenReceivedIfExists(options);\r\n        this.inImplicitFlow = false;\r\n        return true;\r\n      })\r\n      .catch(reason => {\r\n        this.eventsSubject.next(\r\n          new OAuthErrorEvent('token_validation_error', reason)\r\n        );\r\n        this.logger.error('Error validating tokens');\r\n        this.logger.error(reason);\r\n        return Promise.reject(reason);\r\n      });\r\n  }\r\n\r\n  private parseState(state: string): [string, string] {\r\n    let nonce = state;\r\n    let userState = '';\r\n\r\n    if (state) {\r\n      const idx = state.indexOf(this.config.nonceStateSeparator);\r\n      if (idx > -1) {\r\n        nonce = state.substr(0, idx);\r\n        userState = state.substr(idx + this.config.nonceStateSeparator.length);\r\n      }\r\n    }\r\n    return [nonce, userState];\r\n  }\r\n\r\n  protected validateNonce(nonceInState: string): boolean {\r\n    let savedNonce;\r\n\r\n    if (\r\n      this.saveNoncesInLocalStorage &&\r\n      typeof window['localStorage'] !== 'undefined'\r\n    ) {\r\n      savedNonce = localStorage.getItem('nonce');\r\n    } else {\r\n      savedNonce = this._storage.getItem('nonce');\r\n    }\r\n\r\n    if (savedNonce !== nonceInState) {\r\n      const err = 'Validating access_token failed, wrong state/nonce.';\r\n      console.error(err, savedNonce, nonceInState);\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  protected storeIdToken(idToken: ParsedIdToken): void {\r\n    this._storage.setItem('id_token', idToken.idToken);\r\n    this._storage.setItem('id_token_claims_obj', idToken.idTokenClaimsJson);\r\n    this._storage.setItem('id_token_expires_at', '' + idToken.idTokenExpiresAt);\r\n    this._storage.setItem('id_token_stored_at', '' + Date.now());\r\n  }\r\n\r\n  protected storeSessionState(sessionState: string): void {\r\n    this._storage.setItem('session_state', sessionState);\r\n  }\r\n\r\n  protected getSessionState(): string {\r\n    return this._storage.getItem('session_state');\r\n  }\r\n\r\n  protected handleLoginError(options: LoginOptions, parts: object): void {\r\n    if (options.onLoginError) {\r\n      options.onLoginError(parts);\r\n    }\r\n    if (this.clearHashAfterLogin && !options.preventClearHashAfterLogin) {\r\n      location.hash = '';\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  public processIdToken(\r\n    idToken: string,\r\n    accessToken: string,\r\n    skipNonceCheck = false\r\n  ): Promise<ParsedIdToken> {\r\n    const tokenParts = idToken.split('.');\r\n    const headerBase64 = this.padBase64(tokenParts[0]);\r\n    const headerJson = b64DecodeUnicode(headerBase64);\r\n    const header = JSON.parse(headerJson);\r\n    const claimsBase64 = this.padBase64(tokenParts[1]);\r\n    const claimsJson = b64DecodeUnicode(claimsBase64);\r\n    const claims = JSON.parse(claimsJson);\r\n\r\n    let savedNonce;\r\n    if (\r\n      this.saveNoncesInLocalStorage &&\r\n      typeof window['localStorage'] !== 'undefined'\r\n    ) {\r\n      savedNonce = localStorage.getItem('nonce');\r\n    } else {\r\n      savedNonce = this._storage.getItem('nonce');\r\n    }\r\n\r\n    if (Array.isArray(claims.aud)) {\r\n      if (claims.aud.every(v => v !== this.clientId)) {\r\n        const err = 'Wrong audience: ' + claims.aud.join(',');\r\n        this.logger.warn(err);\r\n        return Promise.reject(err);\r\n      }\r\n    } else {\r\n      if (claims.aud !== this.clientId) {\r\n        const err = 'Wrong audience: ' + claims.aud;\r\n        this.logger.warn(err);\r\n        return Promise.reject(err);\r\n      }\r\n    }\r\n\r\n    if (!claims.sub) {\r\n      const err = 'No sub claim in id_token';\r\n      this.logger.warn(err);\r\n      return Promise.reject(err);\r\n    }\r\n\r\n    /* For now, we only check whether the sub against\r\n     * silentRefreshSubject when sessionChecksEnabled is on\r\n     * We will reconsider in a later version to do this\r\n     * in every other case too.\r\n     */\r\n    if (\r\n      this.sessionChecksEnabled &&\r\n      this.silentRefreshSubject &&\r\n      this.silentRefreshSubject !== claims['sub']\r\n    ) {\r\n      const err =\r\n        'After refreshing, we got an id_token for another user (sub). ' +\r\n        `Expected sub: ${this.silentRefreshSubject}, received sub: ${claims['sub']}`;\r\n\r\n      this.logger.warn(err);\r\n      return Promise.reject(err);\r\n    }\r\n\r\n    if (!claims.iat) {\r\n      const err = 'No iat claim in id_token';\r\n      this.logger.warn(err);\r\n      return Promise.reject(err);\r\n    }\r\n\r\n    if (!this.skipIssuerCheck && claims.iss !== this.issuer) {\r\n      const err = 'Wrong issuer: ' + claims.iss;\r\n      this.logger.warn(err);\r\n      return Promise.reject(err);\r\n    }\r\n\r\n    if (!skipNonceCheck && claims.nonce !== savedNonce) {\r\n      const err = 'Wrong nonce: ' + claims.nonce;\r\n      this.logger.warn(err);\r\n      return Promise.reject(err);\r\n    }\r\n    // at_hash is not applicable to authorization code flow\r\n    // addressing https://github.com/manfredsteyer/angular-oauth2-oidc/issues/661\r\n    // i.e. Based on spec the at_hash check is only true for implicit code flow on Ping Federate\r\n    // https://www.pingidentity.com/developer/en/resources/openid-connect-developers-guide.html\r\n    if (\r\n      this.hasOwnProperty('responseType') &&\r\n      (this.responseType === 'code' || this.responseType === 'id_token')\r\n    ) {\r\n      this.disableAtHashCheck = true;\r\n    }\r\n    if (\r\n      !this.disableAtHashCheck &&\r\n      this.requestAccessToken &&\r\n      !claims['at_hash']\r\n    ) {\r\n      const err = 'An at_hash is needed!';\r\n      this.logger.warn(err);\r\n      return Promise.reject(err);\r\n    }\r\n\r\n    const now = Date.now();\r\n    const issuedAtMSec = claims.iat * 1000;\r\n    const expiresAtMSec = claims.exp * 1000;\r\n    const clockSkewInMSec = (this.clockSkewInSec || 600) * 1000;\r\n\r\n    if (\r\n      issuedAtMSec - clockSkewInMSec >= now ||\r\n      expiresAtMSec + clockSkewInMSec <= now\r\n    ) {\r\n      const err = 'Token has expired';\r\n      console.error(err);\r\n      console.error({\r\n        now: now,\r\n        issuedAtMSec: issuedAtMSec,\r\n        expiresAtMSec: expiresAtMSec\r\n      });\r\n      return Promise.reject(err);\r\n    }\r\n\r\n    const validationParams: ValidationParams = {\r\n      accessToken: accessToken,\r\n      idToken: idToken,\r\n      jwks: this.jwks,\r\n      idTokenClaims: claims,\r\n      idTokenHeader: header,\r\n      loadKeys: () => this.loadJwks()\r\n    };\r\n\r\n    if (this.disableAtHashCheck) {\r\n      return this.checkSignature(validationParams).then(_ => {\r\n        const result: ParsedIdToken = {\r\n          idToken: idToken,\r\n          idTokenClaims: claims,\r\n          idTokenClaimsJson: claimsJson,\r\n          idTokenHeader: header,\r\n          idTokenHeaderJson: headerJson,\r\n          idTokenExpiresAt: expiresAtMSec\r\n        };\r\n        return result;\r\n      });\r\n    }\r\n\r\n    return this.checkAtHash(validationParams).then(atHashValid => {\r\n      if (!this.disableAtHashCheck && this.requestAccessToken && !atHashValid) {\r\n        const err = 'Wrong at_hash';\r\n        this.logger.warn(err);\r\n        return Promise.reject(err);\r\n      }\r\n\r\n      return this.checkSignature(validationParams).then(_ => {\r\n        const atHashCheckEnabled = !this.disableAtHashCheck;\r\n        const result: ParsedIdToken = {\r\n          idToken: idToken,\r\n          idTokenClaims: claims,\r\n          idTokenClaimsJson: claimsJson,\r\n          idTokenHeader: header,\r\n          idTokenHeaderJson: headerJson,\r\n          idTokenExpiresAt: expiresAtMSec\r\n        };\r\n        if (atHashCheckEnabled) {\r\n          return this.checkAtHash(validationParams).then(atHashValid1 => {\r\n            if (this.requestAccessToken && !atHashValid1) {\r\n              const err = 'Wrong at_hash';\r\n              this.logger.warn(err);\r\n              return Promise.reject(err);\r\n            } else {\r\n              return result;\r\n            }\r\n          });\r\n        } else {\r\n          return result;\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Returns the received claims about the user.\r\n   */\r\n  public getIdentityClaims(): object {\r\n    const claims = this._storage.getItem('id_token_claims_obj');\r\n    if (!claims) {\r\n      return null;\r\n    }\r\n    return JSON.parse(claims);\r\n  }\r\n\r\n  /**\r\n   * Returns the granted scopes from the server.\r\n   */\r\n  public getGrantedScopes(): object {\r\n    const scopes = this._storage.getItem('granted_scopes');\r\n    if (!scopes) {\r\n      return null;\r\n    }\r\n    return JSON.parse(scopes);\r\n  }\r\n\r\n  /**\r\n   * Returns the current id_token.\r\n   */\r\n  public getIdToken(): string {\r\n    return this._storage ? this._storage.getItem('id_token') : null;\r\n  }\r\n\r\n  protected padBase64(base64data): string {\r\n    while (base64data.length % 4 !== 0) {\r\n      base64data += '=';\r\n    }\r\n    return base64data;\r\n  }\r\n\r\n  /**\r\n   * Returns the current access_token.\r\n   */\r\n  public getAccessToken(): string {\r\n    return this._storage ? this._storage.getItem('access_token') : null;\r\n  }\r\n\r\n  public getRefreshToken(): string {\r\n    return this._storage ? this._storage.getItem('refresh_token') : null;\r\n  }\r\n\r\n  /**\r\n   * Returns the expiration date of the access_token\r\n   * as milliseconds since 1970.\r\n   */\r\n  public getAccessTokenExpiration(): number {\r\n    if (!this._storage.getItem('expires_at')) {\r\n      return null;\r\n    }\r\n    return parseInt(this._storage.getItem('expires_at'), 10);\r\n  }\r\n\r\n  protected getAccessTokenStoredAt(): number {\r\n    return parseInt(this._storage.getItem('access_token_stored_at'), 10);\r\n  }\r\n\r\n  protected getIdTokenStoredAt(): number {\r\n    return parseInt(this._storage.getItem('id_token_stored_at'), 10);\r\n  }\r\n\r\n  /**\r\n   * Returns the expiration date of the id_token\r\n   * as milliseconds since 1970.\r\n   */\r\n  public getIdTokenExpiration(): number {\r\n    if (!this._storage.getItem('id_token_expires_at')) {\r\n      return null;\r\n    }\r\n\r\n    return parseInt(this._storage.getItem('id_token_expires_at'), 10);\r\n  }\r\n\r\n  /**\r\n   * Checkes, whether there is a valid access_token.\r\n   */\r\n  public hasValidAccessToken(): boolean {\r\n    if (this.getAccessToken()) {\r\n      const expiresAt = this._storage.getItem('expires_at');\r\n      const now = new Date();\r\n      if (expiresAt && parseInt(expiresAt, 10) < now.getTime()) {\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Checks whether there is a valid id_token.\r\n   */\r\n  public hasValidIdToken(): boolean {\r\n    if (this.getIdToken()) {\r\n      const expiresAt = this._storage.getItem('id_token_expires_at');\r\n      const now = new Date();\r\n      if (expiresAt && parseInt(expiresAt, 10) < now.getTime()) {\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Retrieve a saved custom property of the TokenReponse object. Only if predefined in authconfig.\r\n   */\r\n  public getCustomTokenResponseProperty(requestedProperty: string): any {\r\n    return this._storage &&\r\n      this.config.customTokenParameters &&\r\n      this.config.customTokenParameters.indexOf(requestedProperty) >= 0 &&\r\n      this._storage.getItem(requestedProperty) !== null\r\n      ? JSON.parse(this._storage.getItem(requestedProperty))\r\n      : null;\r\n  }\r\n\r\n  /**\r\n   * Returns the auth-header that can be used\r\n   * to transmit the access_token to a service\r\n   */\r\n  public authorizationHeader(): string {\r\n    return 'Bearer ' + this.getAccessToken();\r\n  }\r\n\r\n  /**\r\n   * Removes all tokens and logs the user out.\r\n   * If a logout url is configured, the user is\r\n   * redirected to it with optional state parameter.\r\n   * @param noRedirectToLogoutUrl\r\n   * @param state\r\n   */\r\n  public logOut(): void;\r\n  public logOut(customParameters: object): void;\r\n  public logOut(noRedirectToLogoutUrl: boolean): void;\r\n  public logOut(noRedirectToLogoutUrl: boolean, state: string): void;\r\n  public logOut(customParameters: boolean | object = {}, state = ''): void {\r\n    let noRedirectToLogoutUrl = false;\r\n    if (typeof customParameters === 'boolean') {\r\n      noRedirectToLogoutUrl = customParameters;\r\n      customParameters = {};\r\n    }\r\n\r\n    const id_token = this.getIdToken();\r\n    this._storage.removeItem('access_token');\r\n    this._storage.removeItem('id_token');\r\n    this._storage.removeItem('refresh_token');\r\n\r\n    if (this.saveNoncesInLocalStorage) {\r\n      localStorage.removeItem('nonce');\r\n      localStorage.removeItem('PKCE_verifier');\r\n    } else {\r\n      this._storage.removeItem('nonce');\r\n      this._storage.removeItem('PKCE_verifier');\r\n    }\r\n\r\n    this._storage.removeItem('expires_at');\r\n    this._storage.removeItem('id_token_claims_obj');\r\n    this._storage.removeItem('id_token_expires_at');\r\n    this._storage.removeItem('id_token_stored_at');\r\n    this._storage.removeItem('access_token_stored_at');\r\n    this._storage.removeItem('granted_scopes');\r\n    this._storage.removeItem('session_state');\r\n    if (this.config.customTokenParameters) {\r\n      this.config.customTokenParameters.forEach(customParam =>\r\n        this._storage.removeItem(customParam)\r\n      );\r\n    }\r\n    this.silentRefreshSubject = null;\r\n\r\n    this.eventsSubject.next(new OAuthInfoEvent('logout'));\r\n\r\n    if (!this.logoutUrl) {\r\n      return;\r\n    }\r\n    if (noRedirectToLogoutUrl) {\r\n      return;\r\n    }\r\n\r\n    if (!id_token && !this.postLogoutRedirectUri) {\r\n      return;\r\n    }\r\n\r\n    let logoutUrl: string;\r\n\r\n    if (!this.validateUrlForHttps(this.logoutUrl)) {\r\n      throw new Error(\r\n        \"logoutUrl  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).\"\r\n      );\r\n    }\r\n\r\n    // For backward compatibility\r\n    if (this.logoutUrl.indexOf('{{') > -1) {\r\n      logoutUrl = this.logoutUrl\r\n        .replace(/\\{\\{id_token\\}\\}/, id_token)\r\n        .replace(/\\{\\{client_id\\}\\}/, this.clientId);\r\n    } else {\r\n      let params = new HttpParams();\r\n\r\n      if (id_token) {\r\n        params = params.set('id_token_hint', id_token);\r\n      }\r\n\r\n      const postLogoutUrl = this.postLogoutRedirectUri || this.redirectUri;\r\n      if (postLogoutUrl) {\r\n        params = params.set('post_logout_redirect_uri', postLogoutUrl);\r\n\r\n        if (state) {\r\n          params = params.set('state', state);\r\n        }\r\n      }\r\n\r\n      for (let key in customParameters) {\r\n        params = params.set(key, customParameters[key]);\r\n      }\r\n\r\n      logoutUrl =\r\n        this.logoutUrl +\r\n        (this.logoutUrl.indexOf('?') > -1 ? '&' : '?') +\r\n        params.toString();\r\n    }\r\n    this.config.openUri(logoutUrl);\r\n  }\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  public createAndSaveNonce(): Promise<string> {\r\n    const that = this;\r\n    return this.createNonce().then(function(nonce: any) {\r\n      // Use localStorage for nonce if possible\r\n      // localStorage is the only storage who survives a\r\n      // redirect in ALL browsers (also IE)\r\n      // Otherwiese we'd force teams who have to support\r\n      // IE into using localStorage for everything\r\n      if (\r\n        that.saveNoncesInLocalStorage &&\r\n        typeof window['localStorage'] !== 'undefined'\r\n      ) {\r\n        localStorage.setItem('nonce', nonce);\r\n      } else {\r\n        that._storage.setItem('nonce', nonce);\r\n      }\r\n      return nonce;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  public ngOnDestroy(): void {\r\n    this.clearAccessTokenTimer();\r\n    this.clearIdTokenTimer();\r\n\r\n    this.removeSilentRefreshEventListener();\r\n    const silentRefreshFrame = this.document.getElementById(\r\n      this.silentRefreshIFrameName\r\n    );\r\n    if (silentRefreshFrame) {\r\n      silentRefreshFrame.remove();\r\n    }\r\n\r\n    this.stopSessionCheckTimer();\r\n    this.removeSessionCheckEventListener();\r\n    const sessionCheckFrame = this.document.getElementById(\r\n      this.sessionCheckIFrameName\r\n    );\r\n    if (sessionCheckFrame) {\r\n      sessionCheckFrame.remove();\r\n    }\r\n  }\r\n\r\n  protected createNonce(): Promise<string> {\r\n    return new Promise(resolve => {\r\n      if (this.rngUrl) {\r\n        throw new Error(\r\n          'createNonce with rng-web-api has not been implemented so far'\r\n        );\r\n      }\r\n\r\n      /*\r\n       * This alphabet is from:\r\n       * https://tools.ietf.org/html/rfc7636#section-4.1\r\n       *\r\n       * [A-Z] / [a-z] / [0-9] / \"-\" / \".\" / \"_\" / \"~\"\r\n       */\r\n      const unreserved =\r\n        'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';\r\n      let size = 45;\r\n      let id = '';\r\n\r\n      const crypto =\r\n        typeof self === 'undefined' ? null : self.crypto || self['msCrypto'];\r\n      if (crypto) {\r\n        let bytes = new Uint8Array(size);\r\n        crypto.getRandomValues(bytes);\r\n\r\n        // Needed for IE\r\n        if (!bytes.map) {\r\n          (bytes as any).map = Array.prototype.map;\r\n        }\r\n\r\n        bytes = bytes.map(x => unreserved.charCodeAt(x % unreserved.length));\r\n        id = String.fromCharCode.apply(null, bytes);\r\n      } else {\r\n        while (0 < size--) {\r\n          id += unreserved[(Math.random() * unreserved.length) | 0];\r\n        }\r\n      }\r\n\r\n      resolve(base64UrlEncode(id));\r\n    });\r\n  }\r\n\r\n  protected async checkAtHash(params: ValidationParams): Promise<boolean> {\r\n    if (!this.tokenValidationHandler) {\r\n      this.logger.warn(\r\n        'No tokenValidationHandler configured. Cannot check at_hash.'\r\n      );\r\n      return true;\r\n    }\r\n    return this.tokenValidationHandler.validateAtHash(params);\r\n  }\r\n\r\n  protected checkSignature(params: ValidationParams): Promise<any> {\r\n    if (!this.tokenValidationHandler) {\r\n      this.logger.warn(\r\n        'No tokenValidationHandler configured. Cannot check signature.'\r\n      );\r\n      return Promise.resolve(null);\r\n    }\r\n    return this.tokenValidationHandler.validateSignature(params);\r\n  }\r\n\r\n  /**\r\n   * Start the implicit flow or the code flow,\r\n   * depending on your configuration.\r\n   */\r\n  public initLoginFlow(additionalState = '', params = {}): void {\r\n    if (this.responseType === 'code') {\r\n      return this.initCodeFlow(additionalState, params);\r\n    } else {\r\n      return this.initImplicitFlow(additionalState, params);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Starts the authorization code flow and redirects to user to\r\n   * the auth servers login url.\r\n   */\r\n  public initCodeFlow(additionalState = '', params = {}): void {\r\n    if (this.loginUrl !== '') {\r\n      this.initCodeFlowInternal(additionalState, params);\r\n    } else {\r\n      this.events\r\n        .pipe(filter(e => e.type === 'discovery_document_loaded'))\r\n        .subscribe(_ => this.initCodeFlowInternal(additionalState, params));\r\n    }\r\n  }\r\n\r\n  private initCodeFlowInternal(additionalState = '', params = {}): void {\r\n    if (!this.validateUrlForHttps(this.loginUrl)) {\r\n      throw new Error(\r\n        \"loginUrl  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).\"\r\n      );\r\n    }\r\n\r\n    this.createLoginUrl(additionalState, '', null, false, params)\r\n      .then(this.config.openUri)\r\n      .catch(error => {\r\n        console.error('Error in initAuthorizationCodeFlow');\r\n        console.error(error);\r\n      });\r\n  }\r\n\r\n  protected async createChallangeVerifierPairForPKCE(): Promise<\r\n    [string, string]\r\n  > {\r\n    if (!this.crypto) {\r\n      throw new Error(\r\n        'PKCE support for code flow needs a CryptoHander. Did you import the OAuthModule using forRoot() ?'\r\n      );\r\n    }\r\n\r\n    const verifier = await this.createNonce();\r\n    const challengeRaw = await this.crypto.calcHash(verifier, 'sha-256');\r\n    const challenge = base64UrlEncode(challengeRaw);\r\n\r\n    return [challenge, verifier];\r\n  }\r\n\r\n  private extractRecognizedCustomParameters(\r\n    tokenResponse: TokenResponse\r\n  ): Map<string, string> {\r\n    let foundParameters: Map<string, string> = new Map<string, string>();\r\n    if (!this.config.customTokenParameters) {\r\n      return foundParameters;\r\n    }\r\n    this.config.customTokenParameters.forEach((recognizedParameter: string) => {\r\n      if (tokenResponse[recognizedParameter]) {\r\n        foundParameters.set(\r\n          recognizedParameter,\r\n          JSON.stringify(tokenResponse[recognizedParameter])\r\n        );\r\n      }\r\n    });\r\n    return foundParameters;\r\n  }\r\n\r\n  /**\r\n   * Revokes the auth token to secure the vulnarability\r\n   * of the token issued allowing the authorization server to clean\r\n   * up any security credentials associated with the authorization\r\n   */\r\n  public revokeTokenAndLogout(\r\n    customParameters: object = {},\r\n    ignoreCorsIssues = false\r\n  ): Promise<any> {\r\n    let revokeEndpoint = this.revocationEndpoint;\r\n    let accessToken = this.getAccessToken();\r\n    let refreshToken = this.getRefreshToken();\r\n\r\n    if (!accessToken) {\r\n      return;\r\n    }\r\n\r\n    let params = new HttpParams();\r\n\r\n    let headers = new HttpHeaders().set(\r\n      'Content-Type',\r\n      'application/x-www-form-urlencoded'\r\n    );\r\n\r\n    if (this.useHttpBasicAuth) {\r\n      const header = btoa(`${this.clientId}:${this.dummyClientSecret}`);\r\n      headers = headers.set('Authorization', 'Basic ' + header);\r\n    }\r\n\r\n    if (!this.useHttpBasicAuth) {\r\n      params = params.set('client_id', this.clientId);\r\n    }\r\n\r\n    if (!this.useHttpBasicAuth && this.dummyClientSecret) {\r\n      params = params.set('client_secret', this.dummyClientSecret);\r\n    }\r\n\r\n    if (this.customQueryParams) {\r\n      for (const key of Object.getOwnPropertyNames(this.customQueryParams)) {\r\n        params = params.set(key, this.customQueryParams[key]);\r\n      }\r\n    }\r\n\r\n    return new Promise((resolve, reject) => {\r\n      let revokeAccessToken: Observable<void>;\r\n      let revokeRefreshToken: Observable<void>;\r\n\r\n      if (accessToken) {\r\n        let revokationParams = params\r\n          .set('token', accessToken)\r\n          .set('token_type_hint', 'access_token');\r\n        revokeAccessToken = this.http.post<void>(\r\n          revokeEndpoint,\r\n          revokationParams,\r\n          { headers }\r\n        );\r\n      } else {\r\n        revokeAccessToken = of(null);\r\n      }\r\n\r\n      if (refreshToken) {\r\n        let revokationParams = params\r\n          .set('token', refreshToken)\r\n          .set('token_type_hint', 'refresh_token');\r\n        revokeRefreshToken = this.http.post<void>(\r\n          revokeEndpoint,\r\n          revokationParams,\r\n          { headers }\r\n        );\r\n      } else {\r\n        revokeRefreshToken = of(null);\r\n      }\r\n\r\n      if (ignoreCorsIssues) {\r\n        revokeAccessToken = revokeAccessToken.pipe(\r\n          catchError((err: HttpErrorResponse) => {\r\n            if (err.status === 0) {\r\n              return of<void>(null);\r\n            }\r\n            return throwError(err);\r\n          })\r\n        );\r\n\r\n        revokeRefreshToken = revokeRefreshToken.pipe(\r\n          catchError((err: HttpErrorResponse) => {\r\n            if (err.status === 0) {\r\n              return of<void>(null);\r\n            }\r\n            return throwError(err);\r\n          })\r\n        );\r\n      }\r\n\r\n      combineLatest([revokeAccessToken, revokeRefreshToken]).subscribe(\r\n        res => {\r\n          this.logOut(customParameters);\r\n          resolve(res);\r\n          this.logger.info('Token successfully revoked');\r\n        },\r\n        err => {\r\n          this.logger.error('Error revoking token', err);\r\n          this.eventsSubject.next(\r\n            new OAuthErrorEvent('token_revoke_error', err)\r\n          );\r\n          reject(err);\r\n        }\r\n      );\r\n    });\r\n  }\r\n}\r\n","export abstract class OAuthModuleConfig {\r\n  resourceServer: OAuthResourceServerConfig;\r\n}\r\n\r\nexport abstract class OAuthResourceServerConfig {\r\n  /**\r\n   * Urls for which calls should be intercepted.\r\n   * If there is an ResourceServerErrorHandler registered, it is used for them.\r\n   * If sendAccessToken is set to true, the access_token is send to them too.\r\n   */\r\n  allowedUrls?: Array<string>;\r\n  sendAccessToken: boolean;\r\n  customUrlValidation?: (url: string) => boolean;\r\n}\r\n","import { HttpResponse } from '@angular/common/http';\r\nimport { Observable, throwError } from 'rxjs';\r\n\r\nexport abstract class OAuthResourceServerErrorHandler {\r\n  abstract handleError(err: HttpResponse<any>): Observable<any>;\r\n}\r\n\r\nexport class OAuthNoopResourceServerErrorHandler\r\n  implements OAuthResourceServerErrorHandler {\r\n  handleError(err: HttpResponse<any>): Observable<any> {\r\n    return throwError(err);\r\n  }\r\n}\r\n","import { Injectable, Optional } from '@angular/core';\r\n\r\nimport {\r\n  HttpEvent,\r\n  HttpHandler,\r\n  HttpInterceptor,\r\n  HttpRequest\r\n} from '@angular/common/http';\r\nimport { Observable, of, merge } from 'rxjs';\r\nimport {\r\n  catchError,\r\n  filter,\r\n  map,\r\n  take,\r\n  mergeMap,\r\n  timeout\r\n} from 'rxjs/operators';\r\nimport { OAuthResourceServerErrorHandler } from './resource-server-error-handler';\r\nimport { OAuthModuleConfig } from '../oauth-module.config';\r\nimport { OAuthStorage } from '../types';\r\nimport { OAuthService } from '../oauth-service';\r\n\r\n@Injectable()\r\nexport class DefaultOAuthInterceptor implements HttpInterceptor {\r\n  constructor(\r\n    private authStorage: OAuthStorage,\r\n    private oAuthService: OAuthService,\r\n    private errorHandler: OAuthResourceServerErrorHandler,\r\n    @Optional() private moduleConfig: OAuthModuleConfig\r\n  ) {}\r\n\r\n  private checkUrl(url: string): boolean {\r\n    if (this.moduleConfig.resourceServer.customUrlValidation) {\r\n      return this.moduleConfig.resourceServer.customUrlValidation(url);\r\n    }\r\n\r\n    if (this.moduleConfig.resourceServer.allowedUrls) {\r\n      return !!this.moduleConfig.resourceServer.allowedUrls.find(u =>\r\n        url.startsWith(u)\r\n      );\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  public intercept(\r\n    req: HttpRequest<any>,\r\n    next: HttpHandler\r\n  ): Observable<HttpEvent<any>> {\r\n    const url = req.url.toLowerCase();\r\n\r\n    if (\r\n      !this.moduleConfig ||\r\n      !this.moduleConfig.resourceServer ||\r\n      !this.checkUrl(url)\r\n    ) {\r\n      return next.handle(req);\r\n    }\r\n\r\n    const sendAccessToken = this.moduleConfig.resourceServer.sendAccessToken;\r\n\r\n    if (!sendAccessToken) {\r\n      return next\r\n        .handle(req)\r\n        .pipe(catchError(err => this.errorHandler.handleError(err)));\r\n    }\r\n\r\n    return merge(\r\n      of(this.oAuthService.getAccessToken()).pipe(\r\n        filter(token => (token ? true : false))\r\n      ),\r\n      this.oAuthService.events.pipe(\r\n        filter(e => e.type === 'token_received'),\r\n        timeout(this.oAuthService.waitForTokenInMsec || 0),\r\n        catchError(_ => of(null)), // timeout is not an error\r\n        map(_ => this.oAuthService.getAccessToken())\r\n      )\r\n    ).pipe(\r\n      take(1),\r\n      mergeMap(token => {\r\n        if (token) {\r\n          const header = 'Bearer ' + token;\r\n          const headers = req.headers.set('Authorization', header);\r\n          req = req.clone({ headers });\r\n        }\r\n\r\n        return next\r\n          .handle(req)\r\n          .pipe(catchError(err => this.errorHandler.handleError(err)));\r\n      })\r\n    );\r\n  }\r\n}\r\n","import { ValidationHandler, ValidationParams } from './validation-handler';\r\n\r\n/**\r\n * A validation handler that isn't validating nothing.\r\n * Can be used to skip validation (at your own risk).\r\n */\r\nexport class NullValidationHandler implements ValidationHandler {\r\n  validateSignature(validationParams: ValidationParams): Promise<any> {\r\n    return Promise.resolve(null);\r\n  }\r\n  validateAtHash(validationParams: ValidationParams): Promise<boolean> {\r\n    return Promise.resolve(true);\r\n  }\r\n}\r\n","import { MemoryStorage } from './types';\r\n\r\nexport function createDefaultLogger() {\r\n  return console;\r\n}\r\n\r\nexport function createDefaultStorage() {\r\n  return typeof sessionStorage !== 'undefined'\r\n    ? sessionStorage\r\n    : new MemoryStorage();\r\n}\r\n","import { OAuthStorage, OAuthLogger } from './types';\r\nimport { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { HTTP_INTERCEPTORS } from '@angular/common/http';\r\n\r\nimport { OAuthService } from './oauth-service';\r\nimport { UrlHelperService } from './url-helper.service';\r\n\r\nimport { OAuthModuleConfig } from './oauth-module.config';\r\nimport {\r\n  OAuthResourceServerErrorHandler,\r\n  OAuthNoopResourceServerErrorHandler\r\n} from './interceptors/resource-server-error-handler';\r\nimport { DefaultOAuthInterceptor } from './interceptors/default-oauth.interceptor';\r\nimport { ValidationHandler } from './token-validation/validation-handler';\r\nimport { NullValidationHandler } from './token-validation/null-validation-handler';\r\nimport { createDefaultLogger, createDefaultStorage } from './factories';\r\nimport {\r\n  HashHandler,\r\n  DefaultHashHandler\r\n} from './token-validation/hash-handler';\r\n\r\n@NgModule({\r\n  imports: [CommonModule],\r\n  declarations: [],\r\n  exports: []\r\n})\r\nexport class OAuthModule {\r\n  static forRoot(\r\n    config: OAuthModuleConfig = null,\r\n    validationHandlerClass = NullValidationHandler\r\n  ): ModuleWithProviders<OAuthModule> {\r\n    return {\r\n      ngModule: OAuthModule,\r\n      providers: [\r\n        OAuthService,\r\n        UrlHelperService,\r\n        { provide: OAuthLogger, useFactory: createDefaultLogger },\r\n        { provide: OAuthStorage, useFactory: createDefaultStorage },\r\n        { provide: ValidationHandler, useClass: validationHandlerClass },\r\n        { provide: HashHandler, useClass: DefaultHashHandler },\r\n        {\r\n          provide: OAuthResourceServerErrorHandler,\r\n          useClass: OAuthNoopResourceServerErrorHandler\r\n        },\r\n        { provide: OAuthModuleConfig, useValue: config },\r\n        {\r\n          provide: HTTP_INTERCEPTORS,\r\n          useClass: DefaultOAuthInterceptor,\r\n          multi: true\r\n        }\r\n      ]\r\n    };\r\n  }\r\n}\r\n","import { NullValidationHandler } from './null-validation-handler';\r\n\r\nconst err = `PLEASE READ THIS CAREFULLY:\r\n\r\nBeginning with angular-oauth2-oidc version 9, the JwksValidationHandler\r\nhas been moved to an library of its own. If you need it for implementing\r\nOAuth2/OIDC **implicit flow**, please install it using npm:\r\n\r\n  npm i angular-oauth2-oidc-jwks --save\r\n\r\nAfter that, you can import it into your application:\r\n\r\n  import { JwksValidationHandler } from 'angular-oauth2-oidc-jwks';\r\n\r\nPlease note, that this dependency is not needed for the **code flow**,\r\nwhich is nowadays the **recommented** one for single page applications.\r\nThis also results in smaller bundle sizes.\r\n`;\r\n\r\n/**\r\n * This is just a dummy of the JwksValidationHandler\r\n * telling the users that the real one has been moved\r\n * to an library of its own, namely angular-oauth2-oidc-utils\r\n */\r\nexport class JwksValidationHandler extends NullValidationHandler {\r\n  constructor() {\r\n    super();\r\n    console.error(err);\r\n  }\r\n}\r\n","import { InjectionToken } from '@angular/core';\r\nimport { AuthConfig } from './auth.config';\r\n\r\nexport const AUTH_CONFIG = new InjectionToken<AuthConfig>('AUTH_CONFIG');\r\n"]}